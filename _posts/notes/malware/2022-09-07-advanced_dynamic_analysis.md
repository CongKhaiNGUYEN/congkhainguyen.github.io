---
title: Notes | Advanced Dynamic Analysis
author: Zeropio
date: 2022-09-07
categories: [Notes, Malware]
tags: [malware]
permalink: /notes/malware/advanced-dynamic-analysis
---

In this section we will be using debuggers. A debugger is a broker between us (the end user) and the program. We will have completely control over the flow of the program.

# x32dbg :: x64dbg

Once we open the debugger select the malware file. We should see now the CPU tab, with all the info from the CPU. In the middle we can see the assembly language. At the right we have the memory location of every instruction. Below that we have the stack. And in the bottom left we have the hex dump.

We will be using the following controls:

![Untitled](/assets/img/notes/malware/advanced-dynamic/Untitled.png)

| Input | Action |
| --- | --- |
| F9 | Run the program |
| F7 | Step into |
| F8 | Step over |
| F2 | Set a breakpoint |

## Start

Pressing `F9` once will jump the program into the **EntryPoint**.

![Untitled](/assets/img/notes/malware/advanced-dynamic/Untitled%201.png)

> **dropper.download…** is the sample
{: .prompt-info}

## Moving

The debugger will stop the program here. Running it outside a debugger will make the program continuing the execution. We can see that in this first step we are jumping to **BA15F6**. If we press `F8` we will jump to the next line:

![Untitled](/assets/img/notes/malware/advanced-dynamic/Untitled%202.png)

The following line is a `push` to the stack:

![Untitled](/assets/img/notes/malware/advanced-dynamic/Untitled%203.png)

See how when we execute that line, a variable is loaded into the stack:

![Untitled](/assets/img/notes/malware/advanced-dynamic/Untitled%204.png)

If we step into a `call` and press `F7` we will jump into what the call function is using. The `call` is from a function into another part of the program, this `F7` will jump into that function.

## Breakpoints

We can restart the program at anytime to comeback to the initial status. There press `F9` to start the program. In this case, the program has a **breakpoint** at the start, but we can add our own breakpoints. Take for example we see a `call` we want to inspect. Go at this, and once we are in the line we want press `F2` . 

![Untitled](/assets/img/notes/malware/advanced-dynamic/Untitled%205.png)

We will see this red dot, that means it has the breakpoint (we can also click on the dot). Now restart the program. Pressing `F9` will start the program until the first breakpoint. Pressing it again will stop the program on the breakpoint we have just made.

We can set all the breakpoint we want. We can add them to understand the flow of the program. The objective is to find the most interesting instructions and set breakpoints in there to see what they are doing. We have a **Breakpoints** tab with all the available breakpoints.

## Finding

For start finding we must press `F9` to go to the entry point (restart the program if you need it), and keep pressing `F8` until you notice something. Eventually, some function will hang a moment when we pass through it. This can be a interesting function, because here is where the program really start, so add a breakpoint in those.

Right click on that function and select the option **Follow in Dissasembler**. 

![Untitled](/assets/img/notes/malware/advanced-dynamic/Untitled%206.png)

The code start to seem familiar. At this point we have reached the real program. For the `InternetOpenW` we need the **user-agent** value, we can see that just upper it we have the **Mozilla** user-agent declare and pushed to the stack.

We can open **Cutter** to verify it. We can see in both of them the same function.

![Untitled](/assets/img/notes/malware/advanced-dynamic/Untitled%207.png)

We see that in both of them some arguments are being pushing to the stack before the user-agent. Select a breakpoint in the first of them.

Now restart the program and press `F9` until you get to that breakpoint:

![Untitled](/assets/img/notes/malware/advanced-dynamic/Untitled%208.png)

We can see them in the CPU now.

We can combine tools. Using the debugger while using Wireshark, procmon, file system… will give us a better understanding of the malware.
