---
title: Notes | YARA Rules
author: Zeropio
date: 2022-09-10
categories: [Notes, Malware]
tags: [malware]
permalink: /notes/malware/yara-rules
---


After a malware analysis we need to tell the world the malware we have found and how to handle it. For this, we will use **YARA** (Yet Another Ridiculous Acronym) rules. Yara is one of the most powerful detection tool.

By default it is installed in **Flare VM**. We can type in the cmd:

```console
PS C:\Users\zeropio> yara32
	yara: wrong number of arguments
	Usage: yara [OPTION]... [NAMESPACE:]RULES_FILE... FILE | DIR | PID
	
	Try `--help` for more options
```

---

# Rules

Yara takes two input, a rule file and a directory or suspicious file. This is an example for a **.yara** file:

```
rule Yara_Example {
    
    meta: 
        last_updated = "2022-09-10"
        author = "zeropio"
        description = "A sample Yara rule for PMAT"

    strings:
        // Fill out identifying strings and other criteria

    condition:
        // Fill out the conditions that must be met to identify the binary
}
```

All rules must start by **rules <NAME>**, then open brackets as a JSON file. The **meta** field contents information not relevant for the rule, as the author.

In the **strings**, the rule will search that in the files. The syntax is `$<STRING NAME> = "<STRING>" <KEYWORD>`.  We can filter words, portable executable files, hex stringâ€¦ But to make it work we need to create **conditions** that take the variable of before and do something.

For example, to filter portable executable we have the declaration `$PE_magic_byte = "MZ"`. We found this string at the start of the file (in the hex table), so first set at the 0 position:

```
$PE_magic_byte at 0 and
```

We also want to test that if it is a portable executable, it has two strings:

```
$PE_magic_byte at 0 and
($string1 and $string2)
```

Now, we can say that finds both strings or any hex from a variable:

```
$PE_magic_byte at 0 and
($string1 and $string2) or
$hex_string
```

This will be a completely example:

```
rule iambad_malware {
    
    meta: 
        last_updated = "2022-09-10"
        author = "zeropio"
        description = "A sample Yara rule for PMAT"

    strings:
        $string1 = "iambad" ascii
				$string2 = "nim" ascii
				$PE_magic_byte = "MZ"
				$hex_string = { FF E4 ?? 00 FF }

    condition:
        $PE_magic_byte at 0 and
				($string1 and $string2) or
				$hex_string
}
```

---

# Usage

Now that we have our rule, we come back to the terminal. Select the rule, the suspicious file:

```console
PS C:\Users\zeropio> yara32 rule.yara Malware.exe -w -p
	iambad_malware Malware.exe
```

| Flag | Description |
| --- | --- |
| -w | Suppress errors |
| -p <threads> | Number of threads (for yara32 we can pass 32 threads) |
| -s | Print which strings have been founded |
| -r | Recursive  |

We can see in the output that first, it tells us which roles has trigger and with which file.
