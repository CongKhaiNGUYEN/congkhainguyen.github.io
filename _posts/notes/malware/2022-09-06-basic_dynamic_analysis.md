---
title: Notes | Basic Dynamic Analysis
author: Zeropio
date: 2022-09-06
categories: [Notes, Malware]
tags: [malware]
permalink: /notes/malware/basic-dynamic-analysis
---

The major difference from the basic analysis is that here, we are going to run the malware. There are two type of indicator the malware can do, in the **Host** (delete file, install persistence,…) and the **Network** (call a domain, download a file,…).

# Initial Detonation - Network Signatures

Make sure that your main VM has the correct network configuration. Start the `inetsim`service and open a **WireShark** in the Linux host. In the WireShark we can filter by the strings we have identify in the Static Analysis and filter by them.

Take for example a call to a website, we can use the following line in WireShark `http.request.full_uri contains favicon.ico` to search for **favicon.ico** (or any other string from the website). After detonating the malware the first time we can see the request:

![Untitled](/assets/img/notes/malware/basic-dynamic/Untitled.png)

We see that it make a call to a website. Now, we can verify if the strings we found in the other analysis are true.

**Now take a previous snapshot of the VM where the malware hasn’t been detonating yet.**

# Procmon

**Procmon** is part of the **SysInternal Tools**. Search it in the task bar and execute it. We will found a huge amount of information. Click on the filter icon and filter by anything we know, in this case we know the **Process Name** (which is the name of the file). Add it and apply it to make the filter works. We will see now a empty procmon.

![Untitled](/assets/img/notes/malware/basic-dynamic/Untitled%201.png)

Detonate the malware and now we should see a bunch of information.

![Untitled](/assets/img/notes/malware/basic-dynamic/Untitled%202.png)

We can filter them by date, by file…

![Untitled](/assets/img/notes/malware/basic-dynamic/Untitled%203.png)

We can see what files have changed, delete or create the malware.

> Some malwares make a request to **/favicon.ico** because when we load a website we make a GET request to the favicon. A malware can be hidden there, so when we make the GET we download the malware.
{: .prompt-alert}

Take in mind that some malware wouldn’t work without a Internet connection (in this case, a fake Internet connection). We also want to analyze that part with procmon. Detonates the malware again but this time doesn’t start **inetsim**. Check what happens in the flow in procmon, and see if there is something different.

# TCPView

For malware that has a connection to some host we can see it in the **SysInternal Tool** **TCPView**. We can check there if our detonated malware is having a output connection. If we see something, we can try banner grabbing against our IP and the port it will be working:

```console
remnux@remnux:~$ nc -nv <WINDOWS HOST> <PORT>
```

We can trick the malware if it is making a call to a DNS. Edit the file `C:\Windows\System32\drivers\etc\hosts`{: .filepath} and add the line:

```
	127.0.0.1       <DNS DOMAIN>
```

We can use **procmon** now to monitor if it is working. If we can see a connection (for example, through the DNS to a HTTPS) we can start a netcat (`ncat -nvlp 443`inside the Windows host) and detonate the binary to see what are we getting.

# Reverse Shell

Take for example the previous example. We see this:

```console
remnux@remnux:~$ nc -nv 10.0.0.4 5555
	Connection to 10.0.0.4 5555 port [tcp/*] succeeded!
	WytdIHdoYXQgY29tbWFuZCBjYW4gSSBydW4gZm9yIHlvdQ==
	^C
remnux@remnux:~$ echo "WytdIHdoYXQgY29tbWFuZCBjYW4gSSBydW4gZm9yIHlvdQ==" | base64 -d
	[+] what command can I run for you
```

We can guess that this can be a reverse shell. We can try using commands now:

```console
remnux@remnux:~$ nc -nv 10.0.0.4 5555
	Connection to 10.0.0.4 5555 port [tcp/*] succeeded!
	WytdIHdoYXQgY29tbWFuZCBjYW4gSSBydW4gZm9yIHlvdQ==
	whoami
	ZGVza3RvcC1iZjRjbGF1XHplcm9waW8K

remnux@remnux:~$ echo "ZGVza3RvcC1iZjRjbGF1XHplcm9waW8K" | base64 -d
	desktop-bf4clau\zeropio
```

For further analysis, we can start procmon filter by the **process name** and the **operation** contains **TCP**. Now send commands and check again procmon, we should see some output.

# Parent Process

Take for example the **Explorer.EXE** process. This is the father process for the majority of the things a user can do in a Windows system. Malware are usually under this father process.

Some malware can have child process, we can see them in the **Process Tree** to see what other things are doing. Often, malware will try to break this chain process to not be caugh.

In **procmon** we can filter by **Parent PID**. Select the PID from the malware we are analyzing and we should see a bunch of process.
