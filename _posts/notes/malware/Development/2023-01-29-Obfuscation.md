---
title: Notes | Obfuscation
author: Zeropio
date: 2023-01-29
categories: [Notes, Malware]
tags: [malware]
permalink: /notes/malware/obfuscation
---

# Function Call Obfuscation

A function can be imported without making a call, so AV engines can not see the action. For this, we don't need to make a call not the external function (like a DLL) but to the memory direction it is. We can do it with something like:
```cpp
handle = GetModuleHandle("malware.dll")
GetProcAddress(handle, "Function1")
```

For example, let's do it with the function `VirtualProtect`. First, search it and copy the structure:
```cpp
BOOL VirtualProtect(
  LPVOID lpAddress,
  SIZE_T dwSize,
  DWORD  flNewProtect,
  PDWORD lpflOldProtect
);
```

Declare as a global pointer variable:
```cpp
BOOL (WINAPI * pVirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD  flNewProtect, PDWORD lpflOldProtect);
```

Then, before using the function we need to call it:
```cpp
pVirtualProtect = GetProcAddress(GetModuleHandle("kernel32.dll"), "Virtualprotect");
```

## Hardcoded Strings

The issue now is that the string `"VirtualProtect"` is in cleartext. For a better hiding, we can use the `XOR` function:
```cpp
void XOR(char * data, size_t data_len, char * key, size_t key_len) {
	int j;
	
	j = 0;
	for (int i = 0; i < data_len; i++) {
		if (j == key_len - 1) j = 0;

		data[i] = data[i] ^ key[j];
		j++;
	}
}
```

We will create a key and a empty string:
```cpp
	char key[] = <SOME KEY>"";
	char sVirtualProtect[] = "<PAYLOAD>";

   	XOR((char *) sVirtualProtect, strlen(sVirtualProtect), key, sizeof(key));

   	pVirtualProtect = GetProcAddress(GetModuleHandle("kernel32.dll"), sVirtualProtect);
```

> The key can be some text already hardcoded in the binary, so it is less suspicious.
{: .prompt-info}

To generate the payload we can use a `xor` function from Python like:
```python
def xor(data, key):
	l = len(key)
	output_str = ""

	for i in range(len(data)):
		current = data[i]
		current_key = key[i%len(key)]
		output_str += chr(ord(current) ^ ord(current_key))
	
	return output_str
```

And running python as interactive:
```console
C:\Users\Zeropio>C:\Python27\python.exe -i xor.py
. . . <SNIP> . . .

>>> printC(xor("<TEXT TO ENCODE>", "<KEY>"))
```

The output can be write in `char sVirtualProtect[] = "<PAYLOAD>";`.



